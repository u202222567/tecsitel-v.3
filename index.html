<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Tecsitel - Sistema de Gestión Empresarial Integrado con facturación electrónica, contabilidad y cumplimiento normativo">
    <meta name="author" content="Tecsitel">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#dc143c">
    
    <!-- Mejoras de Seguridad: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://i.imgur.com data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    
    <title>Tecsitel - Sistema de Gestión Empresarial Seguro</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/6XXdcPR.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/6XXdcPR.png">
    
    <style>
        /* ===========================
           Variables y Base
        =========================== */
        :root {
            --primary: #dc143c; --primary-dark: #a3102d; --white: #ffffff; --dark: #1f2937;
            --gray-100: #f9fafb; --gray-200: #f3f4f6; --gray-300: #d1d5db; --gray-600: #6b7280; --gray-700: #4b5563;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --success-alpha: rgba(16, 185, 129, 0.1); --warning-alpha: rgba(245, 158, 11, 0.1);
            --danger-alpha: rgba(239, 68, 68, 0.1); --info-alpha: rgba(59, 130, 246, 0.1);
            --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,.25);
            --radius: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-2xl: 24px; --radius-full: 9999px;
            --header-height: 70px; --sidebar-width: 280px; --bottom-nav-height: 60px;
            --transition: 300ms ease; --transition-slow: 500ms ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; }
        body { font-family: var(--font-sans); background: var(--gray-100); color: var(--dark); overflow-x: hidden; }

        /* ===========================
           LOGIN SCREEN (Nuevo)
        =========================== */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 11000; transition: opacity var(--transition-slow);
        }
        .login-form {
            background: var(--white); padding: 40px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl); width: 90%; max-width: 400px;
            animation: slideUp 0.5s ease;
        }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo img { width: 80px; height: 80px; }
        .login-title { text-align: center; font-size: 24px; font-weight: 700; margin-bottom: 30px; }
        
        /* ===========================
           PANTALLA DE CARGA
        =========================== */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: none; align-items: center; justify-content: center;
            z-index: 10000; transition: opacity var(--transition-slow), visibility var(--transition-slow);
            overflow: hidden;
        }
        .loading-particles { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .loading-particles .particle {
            position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            animation: float 8s infinite ease-in-out; 
            bottom: -200px; 
        }
        @keyframes float {
            from { transform: translateY(0) rotate(0deg); opacity: 1; }
            to { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
        }
        .loading-content { text-align: center; position: relative; z-index: 1; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .loading-logo {
            width: 140px; height: 140px; background: rgba(255, 255, 255, 0.95); border-radius: var(--radius-2xl);
            padding: 25px; margin: 0 auto 20px; box-shadow: var(--shadow-2xl);
            animation: pulse 2.5s infinite ease-in-out; display: flex; align-items: center; justify-content: center;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255,255,255,0); } }
        .loading-logo img { width: 100%; height: 100%; object-fit: contain; }
        .loading-title { color: var(--white); font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .loading-status { color: rgba(255, 255, 255, 0.8); font-size: 16px; min-height: 24px; margin-top: 8px; transition: all var(--transition); }
        .loading-status.error { color: #ffcdd2; font-weight: 600; }

        /* ===========================
           App Container y UI General
        =========================== */
        .app-container { display: none; min-height: 100vh; opacity: 0; transition: opacity var(--transition-slow); }
        .app-container.loaded { opacity: 1; display: flex; }
        .sidebar{width:var(--sidebar-width);background:linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);color:var(--white);position:fixed;height:100vh;transition:all var(--transition);z-index:1000;display:flex;flex-direction:column}
        .sidebar-header{padding:30px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}.logo{width:80px;height:80px;background:var(--white);border-radius:var(--radius-xl);margin:0 auto 15px;padding:15px;cursor:pointer}.logo img{width:100%;height:100%}.sidebar-title{font-size:20px;font-weight:700;margin:0}.sidebar-subtitle{font-size:14px;opacity:.8;margin-top:4px}.nav-menu{padding:20px 0;flex-grow:1;overflow-y:auto}.nav-item{display:flex;align-items:center;gap:15px;padding:15px 25px;cursor:pointer;transition:background .2s ease, padding-left .2s ease;border:none;background:0 0;color:var(--white);width:100%;text-align:left;font-size:15px}.nav-item .nav-icon{font-size:24px;width:28px;text-align:center}.nav-item.active,.nav-item:hover{background:rgba(255,255,255,.1);padding-left:30px}.main-content{margin-left:var(--sidebar-width);transition:margin-left var(--transition);width:calc(100% - var(--sidebar-width));display:flex;flex-direction:column;min-height:100vh}.header{height:var(--header-height);background:var(--white);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:0 30px;position:sticky;top:0;z-index:999}.page-title{font-size:24px;font-weight:700;color:var(--dark)}.header-right{display:flex;align-items:center;gap:15px}.content{flex:1;padding:30px;background:var(--gray-100)}

        /* Estilos para elementos de usuario */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .user-avatar:hover {
            background: var(--primary-dark);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        /* Dashboard Metrics */
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Tabs y contenido */
        .tab-content{display:none}.tab-content.active{display:block;animation:fadeIn .3s ease}.card{background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow);margin-bottom:20px}.card-header{padding:20px 25px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}.card-header h3{font-size:18px;font-weight:600;color:var(--dark)}.table-container{overflow-x:auto}.table{width:100%;border-collapse:collapse}.table th,.table td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--gray-200)}.table th{background:var(--gray-100);font-weight:600;color:var(--gray-700)}.table tbody tr:hover{background:var(--gray-100)}.badge{padding:4px 8px;border-radius:var(--radius);font-size:12px;font-weight:600}.badge-success{background:var(--success-alpha);color:var(--success)}.badge-warning{background:var(--warning-alpha);color:var(--warning)}.badge-danger{background:var(--danger-alpha);color:var(--danger)}.badge-info{background:var(--info-alpha);color:var(--info)}

        /* Formularios */
        .form-group{margin-bottom:15px}.form-label{display:block;margin-bottom:5px;font-weight:600;color:var(--dark)}.form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:1px solid var(--gray-300);border-radius:var(--radius);font-size:14px;transition:border-color var(--transition)}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:0;border-color:var(--primary)}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}.form-row-3{grid-template-columns:repeat(3,1fr)}.form-textarea{resize:vertical;min-height:80px}

        /* Botones */
        .btn{display:inline-flex;align-items:center;padding:10px 16px;border:none;border-radius:var(--radius);font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition);text-decoration:none;gap:6px}.btn-primary{background:var(--primary);color:var(--white)}.btn-primary:hover{background:var(--primary-dark)}.btn-secondary{background:var(--gray-600);color:var(--white)}.btn-secondary:hover{background:var(--gray-700)}.btn-success{background:var(--success);color:var(--white)}.btn-success:hover{background:#059669}.btn-warning{background:var(--warning);color:var(--white)}.btn-warning:hover{background:#d97706}.btn-danger{background:var(--danger);color:var(--white)}.btn-danger:hover{background:#dc2626}.btn-sm{padding:6px 12px;font-size:12px}.btn-lg{padding:14px 24px;font-size:16px}

        /* Modales */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000}.modal.active{display:flex}.modal-content{background:var(--white);border-radius:var(--radius-xl);box-shadow:var(--shadow-2xl);width:90%;max-width:500px;max-height:90vh;overflow-y:auto}.modal-header{padding:20px 25px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}.modal-header h3{font-size:20px;font-weight:700}.modal-body{padding:25px}.modal-footer{padding:20px 25px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:10px}.close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-600)}.close-btn:hover{color:var(--dark)}

        /* Toast notifications */
        .toast-container{position:fixed;top:20px;right:20px;z-index:3000}.toast{background:var(--white);padding:15px 20px;border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);margin-bottom:10px;border-left:4px solid var(--info);animation:slideIn .3s ease;opacity:1;transition:opacity .3s ease}.toast-success{border-left-color:var(--success)}.toast-warning{border-left-color:var(--warning)}.toast-error{border-left-color:var(--danger)}

        /* Animaciones */
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}

        /* Employee info styling */
        .employee-info{display:flex;align-items:center;gap:10px}.employee-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px}.employee-details{flex-grow:1}.employee-name{font-weight:600}

        /* Currency and form styling */
        .currency-symbol{font-weight:600;color:var(--primary)}.form-actions{display:flex;justify-content:space-between;align-items:center;margin-top:20px}.checkbox-group{display:flex;align-items:center;gap:8px}.checkbox-group input[type="checkbox"]{width:auto}.file-info{font-size:12px;color:var(--gray-600);margin-top:5px}

        /* Estados y validaciones */
        .loading{pointer-events:none;opacity:.6}.readonly{background:var(--gray-100)!important;cursor:not-allowed}.required{color:var(--danger)}.form-error{color:var(--danger);font-size:12px;margin-top:5px}.success-state{border-color:var(--success)!important}.warning-state{border-color:var(--warning)!important}.error-state{border-color:var(--danger)!important}

        /* Utilitades */
        .text-center{text-align:center}.text-right{text-align:right}.mt-10{margin-top:10px}.mb-10{margin-bottom:10px}.hidden{display:none!important}.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-10{gap:10px}.w-full{width:100%}.bg-white{background:var(--white)}.p-20{padding:20px}.rounded{border-radius:var(--radius)}.shadow{box-shadow:var(--shadow)}

        /* Error handling y estados especiales */
        .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px}.status-active{background:var(--success)}.status-inactive{background:var(--danger)}.status-pending{background:var(--warning)}.filter-controls{display:flex;gap:10px;margin-bottom:20px;align-items:center}.search-box{max-width:300px}.export-controls{display:flex;gap:10px;flex-wrap:wrap}.metric-change{font-size:12px;margin-top:4px}.metric-up{color:var(--success)}.metric-down{color:var(--danger)}.table-actions{display:flex;gap:5px;align-items:center}.action-btn{padding:4px 8px;font-size:11px;border-radius:4px}.progress-bar{height:4px;background:var(--gray-200);border-radius:2px;overflow:hidden}.progress-fill{height:100%;background:var(--primary);transition:width .3s ease}

        /* Accessibility y focus states mejorados */
        .form-input:focus,.form-select:focus,.form-textarea:focus,.btn:focus{box-shadow:0 0 0 3px rgba(220,20,60,.2)}.nav-item:focus{background:rgba(255,255,255,.2);outline:2px solid rgba(255,255,255,.5)}.skip-link{position:absolute;top:-40px;left:6px;background:var(--dark);color:var(--white);padding:8px;text-decoration:none;z-index:100}.skip-link:focus{top:6px}

        /* Print styles */
        @media print{.sidebar,.header,.modal,.toast-container,.btn{display:none!important}.main-content{margin-left:0;width:100%}.table{border:1px solid #000}.table th,.table td{border:1px solid #000}}

        /* Validation y error states mejorados */
        .form-group.has-error .form-input,.form-group.has-error .form-select{border-color:var(--danger);background:rgba(239,68,68,.05)}.form-group.has-success .form-input,.form-group.has-success .form-select{border-color:var(--success);background:rgba(16,185,129,.05)}.input-group{position:relative}.input-group-text{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--gray-600);pointer-events:none}.required-indicator{color:var(--danger);font-weight:bold}.optional-indicator{color:var(--gray-600);font-size:12px;font-style:italic}

        /* Layout responsive mejorado */
        .grid{display:grid}.grid-cols-1{grid-template-columns:1fr}.grid-cols-2{grid-template-columns:repeat(2,1fr)}.grid-cols-3{grid-template-columns:repeat(3,1fr)}.grid-cols-4{grid-template-columns:repeat(4,1fr)}.gap-4{gap:1rem}.gap-6{gap:1.5rem}

        /* Estados de carga y feedback */
        .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}.skeleton-text{height:1rem;border-radius:4px;margin-bottom:8px}.skeleton-button{height:2.5rem;border-radius:6px;width:120px}@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}.empty-state{text-align:center;padding:40px 20px;color:var(--gray-600)}.empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}.data-table-wrapper{position:relative}.data-table-loading{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;z-index:10}

        /* Elementos específicos que agregamos */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--white);
            display: none;
            box-shadow: 0 -2px 10px rgba(0,0,0,.1);
            z-index: 1000;
        }

        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 11px;
            gap: 4px;
            position: relative;
            transition: color 0.2s ease;
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .bottom-nav-item:hover {
            color: var(--primary-dark);
        }

        .bottom-nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            width: 30px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
        }

        .bottom-nav-icon {
            font-size: 18px;
        }

        /* Responsive Design */
        @media(max-width:1024px){.sidebar{transform:translateX(-100%);z-index:1001}.sidebar.active{transform:translateX(0);box-shadow:var(--shadow-2xl)}.main-content{margin-left:0;width:100%}.menu-toggle{display:block!important}}
        @media(max-width:768px){.content{padding:20px;padding-bottom:calc(var(--bottom-nav-height) + 20px)}.header{padding:0 20px}.page-title{font-size:20px}.table{min-width:auto}.hide-mobile{display:none}.form-row{grid-template-columns:1fr}.bottom-nav{display:flex}.dashboard-metrics{grid-template-columns:1fr}.metric-card{text-align:center}}
        @media(max-width:480px){.modal-content{width:95%;margin:10px}.card{margin-bottom:15px}.btn{padding:8px 12px;font-size:13px}.dashboard-metrics{gap:15px}}
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <div class="login-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
            </div>
            <h2 class="login-title">TECSITEL - Acceso Seguro</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" class="form-input" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" class="form-input" id="password" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesión</button>
                <p style="text-align: center; margin-top: 15px; color: var(--gray-600); font-size: 12px;">
                    Demo: admin / admin123
                </p>
            </form>
        </div>
    </div>

    <!-- Pantalla de Carga Mejorada -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-particles" id="loadingParticles"></div>
        <div class="loading-content">
            <div class="loading-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
            </div>
            <h1 class="loading-title">TECSITEL</h1>
            <p class="loading-status" id="loadingStatus">Validando credenciales...</p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="showTab('dashboard')">
                    <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel">
                </div>
                <h2 class="sidebar-title">TECSITEL</h2>
                <p class="sidebar-subtitle">Sistema de Gestión v3.0</p>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="dashboard">
                    <span class="nav-icon">📊</span><span class="nav-text">Dashboard</span>
                </button>
                <button class="nav-item" data-tab="invoices">
                    <span class="nav-icon">📄</span><span class="nav-text">Facturas</span>
                </button>
                <button class="nav-item" data-tab="accounting">
                    <span class="nav-icon">💰</span><span class="nav-text">Contabilidad</span>
                </button>
                 <button class="nav-item" data-tab="personnel">
                    <span class="nav-icon">👥</span><span class="nav-text">Personal</span>
                </button>
                <button class="nav-item" data-tab="compliance">
                    <span class="nav-icon">⚖️</span><span class="nav-text">Cumplimiento</span>
                </button>
                <button class="nav-item" data-tab="sharepoint">
                    <span class="nav-icon">☁️</span><span class="nav-text">Respaldos</span>
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" style="display:none;" onclick="document.getElementById('sidebar').classList.toggle('active')">☰</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <span id="userNameDisplay" style="font-weight: 600; color: var(--dark);">Admin</span>
                            <div style="font-size: 12px; color: var(--gray-600);">Sistema v3.0</div>
                        </div>
                        <button onclick="logout()" class="btn btn-secondary btn-sm" style="margin-left: 10px;">Cerrar Sesión</button>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content active">
                    <div class="dashboard-metrics">
                        <div class="metric-card" style="border-left: 4px solid var(--success);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: var(--success-alpha); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px;">💰</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--dark);" id="totalIncome">S/ 0.00</h3>
                                    <p style="margin: 0; color: var(--gray-600); font-size: 14px;">Ingresos Confirmados</p>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card" style="border-left: 4px solid var(--warning);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: var(--warning-alpha); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px;">⏳</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--dark);" id="pendingIncome">S/ 0.00</h3>
                                    <p style="margin: 0; color: var(--gray-600); font-size: 14px;">Ingresos Pendientes</p>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card" style="border-left: 4px solid var(--info);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: var(--info-alpha); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px;">👥</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--dark);" id="totalEmployees">0</h3>
                                    <p style="margin: 0; color: var(--gray-600); font-size: 14px;">Total Empleados</p>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card" style="border-left: 4px solid var(--primary);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: rgba(220, 20, 60, 0.1); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px;">✅</div>
                                <div>
                                    <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--dark);" id="activeEmployees">0</h3>
                                    <p style="margin: 0; color: var(--gray-600); font-size: 14px;">Empleados Activos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>📄 Facturas Recientes</h3>
                            <button class="btn btn-primary btn-sm" onclick="showTab('invoices')">Ver Todas</button>
                        </div>
                        <div class="table-container">
                            <table class="table" id="recentInvoicesTable">
                                <thead>
                                    <tr>
                                        <th>N° Factura</th>
                                        <th>Cliente</th>
                                        <th class="hide-mobile">Monto</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px;">
                                            No hay facturas registradas
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Facturas -->
                <div id="invoices" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>📄 Gestión de Facturas</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="openModal('newInvoice')">Nueva Factura</button>
                                <button class="btn btn-success" onclick="openModal('registerPayment')">Registrar Cobro</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="invoicesTable">
                                <thead>
                                    <tr>
                                        <th>N° Factura</th>
                                        <th>Cliente</th>
                                        <th class="hide-mobile">RUC</th>
                                        <th>Monto Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            No hay facturas registradas. <a href="#" onclick="openModal('newInvoice')" style="color: var(--primary);">Crear primera factura</a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contabilidad -->
                <div id="accounting" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>💰 Estado Financiero</h3>
                            <button class="btn btn-primary" onclick="generateFinancialReport()">Generar Reporte</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <h4 style="margin-bottom: 15px; color: var(--success);">ACTIVOS</h4>
                                <table class="table">
                                    <tbody>
                                        <tr><td>Efectivo y Bancos</td><td class="text-right" id="cashBalance">S/ 12,500.00</td></tr>
                                        <tr><td>Cuentas por Cobrar</td><td class="text-right" id="receivables">S/ 0.00</td></tr>
                                        <tr><td>Inventarios</td><td class="text-right">S/ 4,200.00</td></tr>
                                        <tr style="font-weight: bold; border-top: 2px solid var(--gray-300);"><td>TOTAL ACTIVOS</td><td class="text-right" id="totalAssets">S/ 16,700.00</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 15px; color: var(--danger);">PASIVOS Y PATRIMONIO</h4>
                                <table class="table">
                                    <tbody>
                                        <tr><td>Cuentas por Pagar</td><td class="text-right">S/ 3,100.00</td></tr>
                                        <tr><td>Impuestos por Pagar</td><td class="text-right" id="taxesPayable">S/ 0.00</td></tr>
                                        <tr style="font-weight: bold;"><td>TOTAL PASIVOS</td><td class="text-right" id="totalLiabilities">S/ 3,100.00</td></tr>
                                        <tr><td>Capital</td><td class="text-right">S/ 15,000.00</td></tr>
                                        <tr><td>Utilidades Retenidas</td><td class="text-right" id="retainedEarnings">-S/ 1,400.00</td></tr>
                                        <tr style="font-weight: bold;"><td>TOTAL PATRIMONIO</td><td class="text-right" id="totalEquity">S/ 13,600.00</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal -->
                <div id="personnel" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>👥 Gestión de Personal</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="openModal('newEmployee')">Nuevo Empleado</button>
                                <button class="btn btn-info" onclick="openModal('timeEntry')">Marcar Asistencia</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="employeesTable">
                                <thead>
                                    <tr>
                                        <th>DNI</th>
                                        <th>Nombre Completo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px;">
                                            Cargando empleados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>⏰ Registro de Asistencia</h3>
                        </div>
                        <div class="table-container">
                            <table class="table" id="timeTrackingTable">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Entrada</th>
                                        <th>Salida</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px;">
                                            No hay marcaciones registradas hoy.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Cumplimiento -->
                <div id="compliance" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>⚖️ Cumplimiento Normativo</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <h4>📋 SUNAT - Facturación Electrónica</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Estado de Certificación:</span>
                                        <span class="badge badge-success">Activo</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Facturas Este Mes:</span>
                                        <span id="monthlyInvoiceCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>IGV Calculado:</span>
                                        <span id="calculatedIGV">S/ 0.00</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="generateSUNATReport()">Reporte SUNAT</button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>👥 Ley de Trabajo</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Empleados Activos:</span>
                                        <span id="activeEmployeeCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Asistencias Este Mes:</span>
                                        <span id="monthlyAttendance">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Cumplimiento:</span>
                                        <span class="badge badge-success">100%</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="generateLaborReport()">Reporte Laboral</button>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h4>📊 Auditoría y Logs</h4>
                            </div>
                            <div style="padding: 20px;">
                                <div style="background: var(--gray-100); padding: 15px; border-radius: var(--radius); font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;" id="auditLog">
                                    [Sistema iniciado] - Sin actividad registrada
                                </div>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-secondary btn-sm" onclick="clearAuditLog()">Limpiar Log</button>
                                    <button class="btn btn-info btn-sm" onclick="exportAuditLog()">Exportar Log</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Respaldos -->
                <div id="sharepoint" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>☁️ Respaldos y Exportación</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <h4>📥 Respaldo Completo</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <p style="margin-bottom: 15px; color: var(--gray-600);">Descarga todos los datos del sistema en formato CSV compatible con Excel.</p>
                                    <button class="btn btn-primary" onclick="downloadFullBackup()">Descargar CSV</button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>💾 Respaldo JSON</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <p style="margin-bottom: 15px; color: var(--gray-600);">Exportar datos estructurados en formato JSON para desarrollo.</p>
                                    <button class="btn btn-info" onclick="downloadJSONBackup()">Descargar JSON</button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>📄 Reportes PDF</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <p style="margin-bottom: 15px; color: var(--gray-600);">Generar reportes en formato PDF para presentación oficial.</p>
                                    <button class="btn btn-warning" onclick="generatePDFReport()">Generar PDF</button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4>📊 Estado del Sistema</h4>
                                </div>
                                <div style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Facturas:</span>
                                        <span id="backupInvoiceCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Empleados:</span>
                                        <span id="backupEmployeeCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Último respaldo:</span>
                                        <span id="lastBackupDate">Nunca</span>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="checkSystemStatus()">Verificar Sistema</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navegación Móvil -->
        <div class="bottom-nav" id="bottomNav">
            <a href="#" class="bottom-nav-item active" data-tab="dashboard">
                <span class="bottom-nav-icon">📊</span>
                Dashboard
            </a>
            <a href="#" class="bottom-nav-item" data-tab="invoices">
                <span class="bottom-nav-icon">📄</span>
                Facturas
            </a>
            <a href="#" class="bottom-nav-item" data-tab="personnel">
                <span class="bottom-nav-icon">👥</span>
                Personal
            </a>
            <a href="#" class="bottom-nav-item" data-tab="compliance">
                <span class="bottom-nav-icon">⚖️</span>
                Legal
            </a>
        </div>
    </div>

    <!-- Modales -->
    <!-- Modal Nueva Factura -->
    <div class="modal" id="newInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Factura</h3>
                <button class="close-btn" onclick="closeModal('newInvoice')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newInvoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Moneda*</label>
                            <select class="form-select" name="currency" onchange="handleCurrencyChange(this.value)" required>
                                <option value="PEN">🇵🇪 Soles (PEN)</option>
                                <option value="USD">🇺🇸 Dólares (USD)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto* <span class="currency-symbol" id="currencySymbol">S/</span></label>
                            <input type="number" class="form-input" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">RUC Cliente*</label>
                            <input type="text" class="form-input" name="clientRuc" maxlength="11" pattern="[0-9]{11}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre/Razón Social*</label>
                            <input type="text" class="form-input" name="clientName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="isExportInvoice" name="isExport">
                            <label for="isExportInvoice">Es factura de exportación (IGV 0%)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Archivo Adjunto</label>
                        <input type="file" class="form-input" name="invoiceFile" accept=".pdf,.jpg,.png">
                        <div class="file-info">Formatos: PDF, JPG, PNG (máx. 5MB)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newInvoice')">Cancelar</button>
                <button type="submit" form="newInvoiceForm" class="btn btn-primary">Guardar Factura</button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Cobro -->
    <div class="modal" id="registerPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Cobro</h3>
                <button class="close-btn" onclick="closeModal('registerPayment')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" onsubmit="savePayment(event)">
                    <div class="form-group">
                        <label class="form-label">Número de Factura*</label>
                        <input type="text" class="form-input" name="invoiceNumber" placeholder="F001-000001" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Cobro*</label>
                            <input type="date" class="form-input" name="paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Método de Pago*</label>
                            <select class="form-select" name="paymentMethod" required>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia Bancaria</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-textarea" name="paymentNotes" placeholder="Detalles adicionales del cobro..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('registerPayment')">Cancelar</button>
                <button type="submit" form="paymentForm" class="btn btn-success">Registrar Cobro</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Empleado -->
    <div class="modal" id="newEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Empleado</h3>
                <button class="close-btn" onclick="closeModal('newEmployee')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newEmployeeForm" onsubmit="saveEmployee(event)">
                    <div class="form-group">
                        <label class="form-label">DNI*</label>
                        <input type="text" class="form-input" name="dni" maxlength="8" pattern="[0-9]{8}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombres*</label>
                            <input type="text" class="form-input" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellidos*</label>
                            <input type="text" class="form-input" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado*</label>
                        <select class="form-select" name="status" required>
                            <option value="Activo">Activo</option>
                            <option value="Vacaciones">Vacaciones</option>
                            <option value="Descanso Médico">Descanso Médico</option>
                            <option value="Cesado">Cesado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas / Observaciones</label>
                        <textarea class="form-textarea" name="notes" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newEmployee')">Cancelar</button>
                <button type="submit" form="newEmployeeForm" class="btn btn-primary">Guardar Empleado</button>
            </div>
        </div>
    </div>

    <!-- Modal Marcar Asistencia -->
    <div class="modal" id="timeEntryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Marcar Asistencia</h3>
                <button class="close-btn" onclick="closeModal('timeEntry')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="timeEntryForm" onsubmit="saveTimeEntry(event)">
                    <div class="form-group">
                        <label class="form-label">Empleado*</label>
                        <select class="form-select" name="employeeId" required>
                            <option value="">Seleccione un empleado...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha*</label>
                        <input type="date" class="form-input" name="entryDate" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hora de Entrada*</label>
                            <input type="time" class="form-input" name="entryTime" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora de Salida</label>
                            <input type="time" class="form-input" name="exitTime">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('timeEntry')">Cancelar</button>
                <button type="submit" form="timeEntryForm" class="btn btn-primary">Guardar Marcación</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Empleado -->
    <div class="modal" id="editEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Empleado</h3>
                <button class="close-btn" onclick="closeModal('editEmployee')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm" onsubmit="updateEmployee(event)">
                    <input type="hidden" name="editDni">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombres*</label>
                            <input type="text" class="form-input" name="editFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellidos*</label>
                            <input type="text" class="form-input" name="editLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado*</label>
                        <select class="form-select" name="editStatus" required>
                            <option value="Activo">Activo</option>
                            <option value="Vacaciones">Vacaciones</option>
                            <option value="Descanso Médico">Descanso Médico</option>
                            <option value="Cesado">Cesado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas / Observaciones</label>
                        <textarea class="form-textarea" name="editNotes" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editEmployee')">Cancelar</button>
                <button type="submit" form="editEmployeeForm" class="btn btn-primary">Actualizar</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ========================================
    // Configuración Global y Estado
    // ========================================
    const CONFIG = {
        IGV_RATE: 0.18,
        LOADING_DURATION: 3000,
        SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutos
        DATABASE_URL: '/.netlify/functions/database', // Para futuro uso con PostgreSQL
    };

    const AppState = { 
        user: null,
        isAuthenticated: false,
        invoices: [],
        employees: [],
        timeEntries: [],
        invoiceCounter: 1,
        sessionStart: null,
    };

    // ========================================
    // Sistema de Autenticación (NUEVO)
    // ========================================
    function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Validación básica (en producción esto sería contra un servidor)
        if (username === 'admin' && password === 'admin123') {
            AppState.isAuthenticated = true;
            AppState.user = { name: username.charAt(0).toUpperCase() + username.slice(1), avatar: 'A' };
            AppState.sessionStart = Date.now();
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            // Simular carga y configuración
            setTimeout(() => {
                initializeApp();
            }, 1000);
        } else {
            showToast('❌ Usuario o contraseña incorrectos', 'error');
        }
    }

    function checkSession() {
        if (AppState.sessionStart && (Date.now() - AppState.sessionStart > CONFIG.SESSION_TIMEOUT)) {
            logout();
            showToast('Su sesión ha expirado', 'warning');
        }
    }

    function logout() {
        if (confirm('¿Está seguro que desea cerrar sesión?')) {
            try {
                AppState.isAuthenticated = false;
                AppState.user = null;
                AppState.sessionStart = null;
                
                // Limpiar datos sensibles
                AppState.invoices = [];
                AppState.employees = [];
                AppState.timeEntries = [];
                
                console.log('Sesión cerrada correctamente');
                showToast('✅ Sesión cerrada correctamente', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error en logout:', error);
                location.reload(); // Fallback
            }
        }
    }

    // ========================================
    // Utilidades de Seguridad (NUEVO)
    // ========================================
    function sanitizeInput(input) {
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML;
    }

    function validateRUC(ruc) {
        return /^[0-9]{11}$/.test(ruc);
    }

    function validateDNI(dni) {
        return /^[0-9]{8}$/.test(dni);
    }

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // ========================================
    // Datos de Ejemplo Mejorados
    // ========================================
    function loadSampleData() {
        AppState.employees = [
            { dni: '48756231', firstName: 'Juan', lastName: 'Pérez García', avatar: 'JP', status: 'Activo', notes: '' },
            { dni: '71234567', firstName: 'María', lastName: 'Rodríguez', avatar: 'MR', status: 'Vacaciones', notes: 'Vacaciones hasta el 15/01' },
            { dni: '78945612', firstName: 'Carlos', lastName: 'Sánchez', avatar: 'CS', status: 'Activo', notes: '' },
            { dni: '12345678', firstName: 'Ana', lastName: 'Torres', avatar: 'AT', status: 'Cesado', notes: 'Fin de contrato' },
        ];
        
        AppState.invoices = [];
        AppState.timeEntries = [];
        AppState.invoiceCounter = 1;
    }

    // ========================================
    // Inicialización CORREGIDA
    // ========================================
    function initializeApp() {
        console.log('=== INICIANDO APLICACIÓN TECSITEL ===');
        console.log('CONFIG:', CONFIG);
        console.log('AppState:', AppState);
        
        try {
            setupLoadingAnimation();
            updateLoadingStatus('Cargando datos seguros...', false);
            loadSampleData();

            setTimeout(() => {
                try {
                    updateLoadingStatus('Configurando interfaz...', false);
                    
                    // Breve pausa para mostrar el mensaje
                    setTimeout(() => {
                        updateLoadingStatus('¡Sistema listo!', false);
                        
                        const loadingScreen = document.getElementById('loadingScreen');
                        const appContainer = document.getElementById('appContainer');

                        if (!loadingScreen || !appContainer) {
                            throw new Error('Elementos críticos de la UI no encontrados');
                        }

                        // Ocultar pantalla de carga
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.visibility = 'hidden';
                        appContainer.style.display = 'flex';
                        
                        setTimeout(() => {
                            try {
                                appContainer.classList.add('loaded');
                                console.log('Renderizando componentes...');
                                renderAllSafely();
                                
                                console.log('Configurando event listeners...');
                                setupEventListeners();
                                
                                // Configurar verificación de sesión
                                setInterval(checkSession, 60000);
                                
                                console.log('✅ Aplicación inicializada correctamente');
                                showToast('✅ Sistema TECSITEL listo', 'success');
                                
                            } catch (error) {
                                console.error('Error en inicialización final:', error);
                                showToast('⚠️ Sistema iniciado con limitaciones', 'warning');
                            }
                        }, 100);
                    }, 500);
                    
                } catch (error) {
                    console.error('Error crítico en inicialización:', error);
                    updateLoadingStatus('Error en la carga - Iniciando modo básico...', true);
                    
                    // Fallback - mostrar aplicación básica después de 2 segundos
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loadingScreen');
                        const appContainer = document.getElementById('appContainer');
                        
                        if (loadingScreen) loadingScreen.style.display = 'none';
                        if (appContainer) {
                            appContainer.style.display = 'flex';
                            appContainer.classList.add('loaded');
                        }
                        
                        showToast('⚠️ Sistema iniciado en modo básico', 'warning');
                    }, 2000);
                }
            }, CONFIG.LOADING_DURATION);
            
        } catch (error) {
            console.error('Error fatal en initializeApp:', error);
            updateLoadingStatus('Error crítico - Contacte al administrador', true);
            
            // Último recurso - mostrar aplicación después de 5 segundos
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
            }, 5000);
        }
    }
    
    function updateLoadingStatus(message, isError = false) {
        const statusElement = document.getElementById('loadingStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.classList.toggle('error', isError);
        }
    }

    function setupLoadingAnimation() {
        const container = document.getElementById('loadingParticles');
        if (!container) return;
        const particleCount = 50;
        for (let i = 0; i < particleCount; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = Math.random() * 6 + 2;
            p.style.cssText = `
                width:${size}px;
                height:${size}px;
                left:${Math.random()*100}%;
                animation-delay:${Math.random() * 8}s;
                animation-duration:${Math.random() * 5 + 4}s;
            `;
            container.appendChild(p);
        }
    }

    // ========================================
    // Renderizado CORREGIDO
    // ========================================
    function renderAllSafely() {
        console.log('Iniciando renderizado seguro...');
        
        try {
            // Verificar y renderizar elementos de usuario solo si existen
            const userAvatar = document.getElementById('userAvatar');
            const userNameDisplay = document.getElementById('userNameDisplay');
            
            if (AppState.user) {
                if (userAvatar) {
                    userAvatar.textContent = AppState.user.avatar || 'U';
                    console.log('✓ userAvatar renderizado');
                } else {
                    console.warn('⚠️ userAvatar no encontrado en DOM');
                }
                
                if (userNameDisplay) {
                    userNameDisplay.textContent = AppState.user.name || 'Usuario';
                    console.log('✓ userNameDisplay renderizado');
                } else {
                    console.warn('⚠️ userNameDisplay no encontrado en DOM');
                }
            }
            
            // Renderizar componentes principales con manejo individual de errores
            const renderFunctions = [
                { name: 'Dashboard', func: renderDashboard },
                { name: 'Invoices', func: renderInvoices },
                { name: 'Employees', func: renderEmployees },
                { name: 'TimeTracking', func: renderTimeTracking },
                { name: 'Accounting', func: renderAccounting },
                { name: 'EmployeeOptions', func: renderEmployeeOptions }
            ];
            
            renderFunctions.forEach(({ name, func }) => {
                try {
                    func();
                    console.log(`✓ ${name} renderizado correctamente`);
                } catch (error) {
                    console.error(`❌ Error renderizando ${name}:`, error);
                    showToast(`⚠️ Error en ${name}`, 'warning');
                }
            });
            
            console.log('✅ Renderizado completado');
            
        } catch (error) {
            console.error('Error general en renderAllSafely:', error);
            showToast('⚠️ Error al cargar algunos componentes', 'warning');
        }
    }
    
    function renderDashboard() {
        try {
            const totalIncome = AppState.invoices
                .filter(inv => inv.status === 'Aprobada')
                .reduce((sum, inv) => sum + (inv.currency === 'USD' ? inv.amount * 3.75 : inv.amount), 0);

            const pendingIncome = AppState.invoices
                .filter(inv => inv.status === 'Pendiente')
                .reduce((sum, inv) => sum + (inv.currency === 'USD' ? inv.amount * 3.75 : inv.amount), 0);

            const totalEmployees = AppState.employees.length;
            const activeEmployees = AppState.employees.filter(emp => emp.status === 'Activo').length;

            // Actualizar métricas principales con verificación de elementos
            const elements = {
                'totalIncome': `S/ ${totalIncome.toFixed(2)}`,
                'pendingIncome': `S/ ${pendingIncome.toFixed(2)}`,
                'totalEmployees': totalEmployees.toString(),
                'activeEmployees': activeEmployees.toString()
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`⚠️ Elemento ${id} no encontrado en dashboard`);
                }
            });

            // Renderizar tabla de facturas recientes
            const recentInvoicesTable = document.querySelector('#recentInvoicesTable tbody');
            if (recentInvoicesTable) {
                recentInvoicesTable.innerHTML = '';
                
                const recentInvoices = AppState.invoices.slice(0, 5);
                recentInvoices.forEach(inv => {
                    const symbol = inv.currency === 'PEN' ? 'S/' : '$';
                    const total = inv.isExport ? inv.amount : inv.amount * (1 + CONFIG.IGV_RATE);
                    const statusClass = inv.status === 'Aprobada' ? 'success' : 
                                      (inv.status === 'Pendiente' ? 'warning' : 'danger');
                    
                    const row = `
                        <tr>
                            <td>${sanitizeInput(inv.invoice_number)}</td>
                            <td>${sanitizeInput(inv.clientName)}</td>
                            <td class="hide-mobile">${symbol} ${total.toFixed(2)}</td>
                            <td><span class="badge badge-${statusClass}">${inv.status}</span></td>
                        </tr>`;
                    recentInvoicesTable.innerHTML += row;
                });
                
                if (recentInvoices.length === 0) {
                    recentInvoicesTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay facturas registradas</td></tr>';
                }
            }

            console.log('✓ Dashboard renderizado correctamente');
            
        } catch (error) {
            console.error('Error en renderDashboard:', error);
            throw error; // Re-lanzar para manejo en renderAllSafely
        }
    }

    function renderInvoices() {
        const allTbody = document.querySelector('#invoicesTable tbody');
        if (!allTbody) return;
        
        allTbody.innerHTML = '';
        if (AppState.invoices.length === 0) {
            allTbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No hay facturas registradas. <a href="#" onclick="openModal('newInvoice')" style="color: var(--primary);">Crear primera factura</a></td></tr>`;
            return;
        }

        AppState.invoices.forEach(inv => {
            const symbol = inv.currency === 'PEN' ? 'S/' : '$';
            const total = inv.isExport ? inv.amount : inv.amount * (1 + CONFIG.IGV_RATE);
            const statusClass = inv.status === 'Aprobada' ? 'success' : (inv.status === 'Pendiente' ? 'warning' : 'danger');
            const allInvoicesRow = `
                <tr>
                    <td>${sanitizeInput(inv.invoice_number)}</td>
                    <td>${sanitizeInput(inv.clientName)}</td>
                    <td class="hide-mobile">${sanitizeInput(inv.clientRuc)}</td>
                    <td>${symbol} ${total.toFixed(2)}</td>
                    <td><span class="badge badge-${statusClass}">${inv.status}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="downloadInvoice(${inv.id})">Ver</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('invoice', ${inv.id})">Borrar</button>
                    </td>
                </tr>`;
            allTbody.innerHTML += allInvoicesRow;
        });
    }

    function renderEmployees() {
        const tableBody = document.querySelector('#employeesTable tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        AppState.employees.forEach(emp => {
            const statusClass = emp.status === 'Activo' ? 'success' : (emp.status === 'Cesado' ? 'danger' : 'warning');
            tableBody.innerHTML += `
                <tr>
                    <td>${emp.dni}</td>
                    <td>${sanitizeInput(emp.firstName)} ${sanitizeInput(emp.lastName)}</td>
                    <td><span class="badge badge-${statusClass}">${emp.status}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editEmployee('${emp.dni}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('employee', '${emp.dni}')">Borrar</button>
                    </td>
                </tr>`;
        });
    }

    function renderTimeTracking() {
        const tableBody = document.querySelector('#timeTrackingTable tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        if (AppState.timeEntries.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No hay marcaciones registradas.</td></tr>`;
            return;
        }
        AppState.timeEntries.forEach(entry => {
            const statusClass = entry.exitTime !== '--:--' ? 'success' : 'warning';
            const statusText = entry.exitTime !== '--:--' ? 'Completo' : 'En jornada';
            tableBody.innerHTML += `
                <tr>
                    <td>
                        <div class="employee-info">
                            <div class="employee-avatar" style="background:#dbeafe;color:#1e40af">${entry.avatar}</div>
                            <div class="employee-details"><div class="employee-name">${sanitizeInput(entry.name)}</div></div>
                        </div>
                    </td>
                    <td>${entry.entryTime}</td>
                    <td>${entry.exitTime}</td>
                    <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteItem('timeEntry', ${entry.id})">Borrar</button></td>
                </tr>`;
        });
    }
    
    function renderAccounting() {
        // Datos actualizados basados en facturas reales
        const totalIncome = AppState.invoices.filter(inv => inv.status === 'Aprobada').reduce((sum, inv) => sum + (inv.currency === 'USD' ? inv.amount * 3.75 : inv.amount), 0);
        const cash = 12500.00 + totalIncome;
        const receivables = AppState.invoices.filter(inv => inv.status === 'Pendiente').reduce((sum, inv) => sum + (inv.currency === 'USD' ? inv.amount * 3.75 : inv.amount), 0);
        const inventory = 4200.00;
        const totalAssets = cash + receivables + inventory;
        
        const payables = 3100.00;
        const taxes = totalIncome * 0.18; // IGV estimado
        const totalLiabilities = payables + taxes;
        
        const capital = 15000.00;
        const retainedEarnings = totalAssets - totalLiabilities - capital;
        const totalEquity = capital + retainedEarnings;
        
        const elements = {
            'cashBalance': `S/ ${cash.toFixed(2)}`,
            'receivables': `S/ ${receivables.toFixed(2)}`,
            'totalAssets': `S/ ${totalAssets.toFixed(2)}`,
            'taxesPayable': `S/ ${taxes.toFixed(2)}`,
            'totalLiabilities': `S/ ${totalLiabilities.toFixed(2)}`,
            'retainedEarnings': `S/ ${retainedEarnings.toFixed(2)}`,
            'totalEquity': `S/ ${totalEquity.toFixed(2)}`
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }
    
    function renderEmployeeOptions() {
        const select = document.querySelector('#timeEntryForm [name="employeeId"]');
        if (!select) return;
        select.innerHTML = '<option value="">Seleccione un empleado...</option>';
        AppState.employees.filter(e => e.status === 'Activo').forEach(emp => {
            select.innerHTML += `<option value="${emp.dni}">${emp.firstName} ${emp.lastName}</option>`;
        });
    }

    // ========================================
    // Event Listeners CORREGIDOS
    // ========================================
    function setupEventListeners() {
        try {
            console.log('Configurando event listeners...');
            
            // Función para manejar clicks de navegación
            const handleTabClick = (tabName) => {
                if (tabName) {
                    console.log(`Navegando a: ${tabName}`);
                    showTab(tabName);
                }
            };

            // Event listener para navegación principal
            document.body.addEventListener('click', e => {
                try {
                    // Cerrar modales al hacer click en overlay
                    if (e.target.matches('.modal-overlay')) {
                        const modalId = e.target.parentElement.id.replace('Modal', '');
                        closeModal(modalId);
                    }
                    
                    // Navegación en sidebar
                    const navItem = e.target.closest('.nav-item');
                    if (navItem && navItem.dataset.tab) {
                        handleTabClick(navItem.dataset.tab);
                    }
                } catch (error) {
                    console.error('Error en event listener body:', error);
                }
            });
            
            // Event listener para navegación móvil (si existe)
            const bottomNav = document.getElementById('bottomNav');
            if (bottomNav) {
                bottomNav.addEventListener('click', e => {
                    try {
                        e.preventDefault();
                        const navItem = e.target.closest('.bottom-nav-item');
                        if (navItem && navItem.dataset.tab) {
                            handleTabClick(navItem.dataset.tab);
                        }
                    } catch (error) {
                        console.error('Error en event listener bottomNav:', error);
                    }
                });
            }
            
            // Configurar fecha actual en formularios
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // Limpiar errores al escribir en formularios
            document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('error');
                    const errorSpan = this.parentElement.querySelector('.form-error');
                    if (errorSpan) errorSpan.textContent = '';
                });
            });
            
            console.log('✓ Event listeners configurados correctamente');
            
        } catch (error) {
            console.error('Error en setupEventListeners:', error);
            throw error;
        }
    }

    // ========================================
    // Funciones de UI y Navegación
    // ========================================
    function showTab(tabName) {
        if (!tabName) return;
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        const tabElement = document.getElementById(tabName);
        if(tabElement) tabElement.classList.add('active');
        
        document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(i => {
            i.classList.toggle('active', i.dataset.tab === tabName);
        });
        
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            pageTitle.textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
        }
        
        if (window.innerWidth <= 1024) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.remove('active');
        }
    }
    
    function openModal(modalName) {
        const modal = document.getElementById(modalName + 'Modal');
        if (modal) {
            modal.classList.add('active');
            modal.style.display = 'flex';
        }
    }
    
    function closeModal(modalName) {
        const modal = document.getElementById(modalName + 'Modal');
        if (modal) {
            modal.classList.remove('active');
            modal.style.display = 'none';
        }
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ========================================
    // Funciones de Gestión de Datos
    // ========================================
    function saveInvoice(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Validar RUC
        const ruc = formData.get('clientRuc');
        if (!validateRUC(ruc)) {
            showToast('RUC debe tener exactamente 11 dígitos numéricos.', 'error');
            return;
        }
        
        const invoiceNumber = `F001-${String(AppState.invoiceCounter).padStart(6, '0')}`;
        AppState.invoiceCounter++;
        
        const newInvoice = {
            id: Date.now(),
            invoice_number: invoiceNumber,
            clientRuc: ruc,
            clientName: formData.get('clientName'),
            currency: formData.get('currency'),
            amount: parseFloat(formData.get('amount')),
            status: 'Pendiente',
            isExport: formData.get('isExport') === 'on',
            date: new Date().toISOString().split('T')[0],
            attachedFile: formData.get('invoiceFile') ? formData.get('invoiceFile').name : null
        };

        AppState.invoices.push(newInvoice);
        showToast('✅ Factura guardada correctamente.', 'success');
        closeModal('newInvoice');
        form.reset();
        handleCurrencyChange('PEN');
        renderInvoices();
        renderDashboard();
        renderAccounting();
    }

    function saveEmployee(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Validar DNI
        const dni = formData.get('dni');
        if (!validateDNI(dni)) {
            showToast('DNI debe tener exactamente 8 dígitos numéricos.', 'error');
            return;
        }
        
        // Verificar que no exista
        if (AppState.employees.find(e => e.dni === dni)) {
            showToast('Ya existe un empleado con este DNI.', 'error');
            return;
        }
        
        const firstName = formData.get('firstName');
        const lastName = formData.get('lastName');
        const newEmployee = {
            dni,
            firstName,
            lastName,
            avatar: firstName.charAt(0) + lastName.charAt(0),
            status: formData.get('status'),
            notes: formData.get('notes') || ''
        };

        AppState.employees.push(newEmployee);
        showToast('✅ Empleado guardado correctamente.', 'success');
        closeModal('newEmployee');
        form.reset();
        renderEmployees();
        renderEmployeeOptions();
        renderDashboard();
    }

    function saveTimeEntry(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const employeeId = formData.get('employeeId');
        const entryDate = formData.get('entryDate');
        const entryTime = formData.get('entryTime');
        const exitTime = formData.get('exitTime') || '--:--';
        const employee = AppState.employees.find(e => e.dni === employeeId);
        
        if (!employee) {
            showToast('Por favor, seleccione un empleado válido.', 'error');
            return;
        }
        
        const newTimeEntry = {
            id: Date.now(),
            dni: employeeId,
            name: `${employee.firstName} ${employee.lastName}`,
            avatar: employee.avatar,
            date: entryDate,
            entryTime,
            exitTime
        };

        AppState.timeEntries.push(newTimeEntry);
        showToast('✅ Marcación guardada correctamente.', 'success');
        closeModal('timeEntry');
        form.reset();
        renderTimeTracking();
    }

    function savePayment(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const invoiceNumber = formData.get('invoiceNumber');
        const invoice = AppState.invoices.find(inv => inv.invoice_number === invoiceNumber);
        if (invoice) {
            invoice.status = 'Aprobada';
            showToast(`✅ Cobro registrado. Factura ${invoiceNumber} actualizada a Aprobada.`, 'success');
            renderInvoices();
            renderDashboard();
            renderAccounting();
        } else {
            showToast(`Factura ${invoiceNumber} no encontrada.`, 'error');
        }