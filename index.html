<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Tecsitel - Sistema de Gestión Empresarial Integrado con facturación electrónica, contabilidad y cumplimiento normativo">
    <meta name="author" content="Tecsitel">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#dc143c">
    
    <!-- Mejoras de Seguridad: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://i.imgur.com data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    
    <title>Tecsitel - Sistema de Gestión Empresarial Seguro</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/6XXdcPR.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/6XXdcPR.png">
    
    <style>
        /* ===========================
           Variables y Base
        =========================== */
        :root {
            --primary: #dc143c; --primary-dark: #a3102d; --white: #ffffff; --dark: #1f2937;
            --gray-100: #f9fafb; --gray-200: #f3f4f6; --gray-300: #d1d5db; --gray-600: #6b7280; --gray-700: #4b5563;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --success-alpha: rgba(16, 185, 129, 0.1); --warning-alpha: rgba(245, 158, 11, 0.1);
            --danger-alpha: rgba(239, 68, 68, 0.1); --info-alpha: rgba(59, 130, 246, 0.1);
            --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,.25);
            --radius: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-2xl: 24px; --radius-full: 9999px;
            --header-height: 70px; --sidebar-width: 280px; --bottom-nav-height: 60px;
            --transition: 300ms ease; --transition-slow: 500ms ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-sans); background: var(--gray-100); line-height: 1.6; overflow-x: hidden; }
        
        /* ===========================
           Layout Principal
        =========================== */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--white); box-shadow: var(--shadow-lg); position: fixed; height: 100vh; z-index: 1000; overflow-y: auto; transition: transform var(--transition); }
        .main-content { margin-left: var(--sidebar-width); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
        .header { height: var(--header-height); background: var(--white); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; position: sticky; top: 0; z-index: 100; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* ===========================
           Sidebar
        =========================== */
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid var(--gray-200); }
        .logo { width: 60px; height: 60px; margin: 0 auto 15px; border-radius: var(--radius-full); overflow: hidden; cursor: pointer; transition: transform var(--transition); }
        .logo:hover { transform: scale(1.05); }
        .logo img { width: 100%; height: 100%; object-fit: cover; }
        .sidebar-title { font-size: 22px; font-weight: 700; color: var(--primary); margin: 0; }
        .sidebar-subtitle { font-size: 12px; color: var(--gray-600); margin: 5px 0 0; }
        
        /* ===========================
           Navegación
        =========================== */
        .nav-menu { padding: 10px 0; }
        .nav-item { width: 100%; padding: 15px 25px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; text-align: left; font-size: 15px; color: var(--gray-600); transition: all var(--transition); border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--gray-100); color: var(--primary); }
        .nav-item.active { background: var(--primary-alpha); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .nav-icon { margin-right: 12px; font-size: 18px; }
        .nav-text { flex: 1; }
        
        /* ===========================
           Header
        =========================== */
        .menu-toggle { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray-600); }
        .page-title { font-size: 28px; font-weight: 700; color: var(--dark); margin: 0; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: var(--radius-full); background: var(--primary); color: var(--white); display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; transition: all var(--transition); }
        .user-avatar:hover { transform: scale(1.1); background: var(--primary-dark); }
        
        /* ===========================
           Panels y Cards
        =========================== */
        .panel { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 25px; overflow: hidden; }
        .panel-header { padding: 20px 25px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: between; align-items: center; }
        .panel-title { font-size: 20px; font-weight: 600; color: var(--dark); margin: 0; }
        .panel-body { padding: 25px; }
        
        /* ===========================
           Stats Grid
        =========================== */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow); transition: transform var(--transition); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-info { flex: 1; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: var(--gray-600); }
        .stat-icon { width: 50px; height: 50px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        /* ===========================
           Botones
        =========================== */
        .btn { padding: 12px 20px; border: none; border-radius: var(--radius); cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all var(--transition); text-decoration: none; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-danger:hover { background: #dc2626; }
        .btn-info { background: var(--info); color: var(--white); }
        .btn-info:hover { background: #2563eb; }
        .btn-icon { font-size: 16px; }
        .btn-text { }
        
        /* ===========================
           Formularios
        =========================== */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 14px; transition: border-color var(--transition); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1); }
        
        /* ===========================
           Tablas
        =========================== */
        .table-responsive { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .table th { font-weight: 600; color: var(--gray-700); background: var(--gray-50); }
        .table tbody tr:hover { background: var(--gray-50); }
        
        /* ===========================
           Modales
        =========================== */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-2xl); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: var(--dark); }
        .close { font-size: 24px; cursor: pointer; color: var(--gray-600); }
        .close:hover { color: var(--danger); }
        .modal-body { padding: 25px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        /* ===========================
           Alertas y Notificaciones
        =========================== */
        .alert { padding: 15px 20px; border-radius: var(--radius); margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-info { background: var(--info-alpha); border: 1px solid rgba(59, 130, 246, 0.2); }
        .alert-success { background: var(--success-alpha); border: 1px solid rgba(16, 185, 129, 0.2); }
        .alert-warning { background: var(--warning-alpha); border: 1px solid rgba(245, 158, 11, 0.2); }
        .alert-danger { background: var(--danger-alpha); border: 1px solid rgba(239, 68, 68, 0.2); }
        .alert-icon { font-size: 18px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-content strong { font-weight: 600; }
        
        /* ===========================
           Toast Notifications
        =========================== */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 15px 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; max-width: 350px; transform: translateX(400px); transition: transform var(--transition); border-left: 4px solid var(--info); }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast-icon { font-size: 18px; }
        .toast-message { flex: 1; font-size: 14px; }
        
        /* ===========================
           Pantalla de Carga
        =========================== */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loading-particles { position: absolute; width: 100%; height: 100%; }
        .loading-content { text-align: center; z-index: 10; }
        .loading-logo { width: 100px; height: 100px; margin: 0 auto 30px; border-radius: var(--radius-full); overflow: hidden; box-shadow: var(--shadow-2xl); }
        .loading-logo img { width: 100%; height: 100%; object-fit: cover; }
        .loading-title { font-size: 48px; font-weight: 700; color: var(--white); margin: 0 0 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .loading-status { font-size: 18px; color: rgba(255,255,255,0.9); margin: 0; }
        
        /* ===========================
           Formulario de Login
        =========================== */
        .login-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); display: flex; align-items: center; justify-content: center; z-index: 9998; }
        .login-form { background: var(--white); padding: 40px; border-radius: var(--radius-xl); box-shadow: var(--shadow-2xl); width: 400px; max-width: 90%; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-logo { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: var(--radius-full); overflow: hidden; }
        .login-logo img { width: 100%; height: 100%; object-fit: cover; }
        .login-title { font-size: 28px; font-weight: 700; color: var(--dark); margin: 0 0 10px; }
        .login-subtitle { font-size: 14px; color: var(--gray-600); margin: 0; }
        
        /* ===========================
           Específicos para nuevos módulos
        =========================== */
        .accounting-dashboard, .payroll-dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .balance-cards, .payroll-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-card, .summary-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .balance-card h4, .summary-card h4 {
            color: var(--gray-600);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-card span {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .payroll-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .admin-section {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .admin-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-200);
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .accounting-details {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px 0;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .account-select, .debe-input, .haber-input {
            padding: 8px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
        }

        .totals {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--gray-200);
            font-weight: bold;
        }
        
        /* ===========================
           Compliance específico
        =========================== */
        .compliance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .compliance-card { background: var(--white); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow); }
        .compliance-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .compliance-icon { width: 50px; height: 50px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .compliance-info h3 { margin: 0 0 5px; font-size: 18px; color: var(--dark); }
        .compliance-info p { margin: 0; font-size: 14px; color: var(--gray-600); }
        .compliance-list { margin-bottom: 20px; }
        .compliance-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
        .check-icon { width: 20px; height: 20px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--white); }
        .compliance-progress { }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .progress-header span { font-size: 14px; color: var(--gray-600); }
        .progress-header strong { font-size: 16px; color: var(--dark); }
        .progress { width: 100%; height: 8px; background: var(--gray-200); border-radius: var(--radius-full); overflow: hidden; }
        .progress-bar { height: 100%; transition: width var(--transition); }
        
        /* ===========================
           Balance Sheet específico
        =========================== */
        .balance-sheet { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .balance-section { background: var(--white); padding: 20px; border-radius: var(--radius); }
        .balance-section h4 { margin: 0 0 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .balance-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200); }
        .balance-total { display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid var(--dark); font-weight: 600; color: var(--dark); margin-top: 10px; }
        
        /* ===========================
           Responsive Design
        =========================== */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .menu-toggle { display: block; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .balance-sheet { grid-template-columns: 1fr; }
            .compliance-grid { grid-template-columns: 1fr; }
            .balance-cards, .payroll-summary { grid-template-columns: 1fr; }
            .admin-grid { grid-template-columns: 1fr; }
            .detail-row { grid-template-columns: 1fr; }
            .payroll-actions { flex-direction: column; }
            .header { padding: 0 15px; }
            .content { padding: 15px; }
            .panel-header { padding: 15px 20px; }
            .panel-body { padding: 20px; }
        }
        
        /* ===========================
           Tab System
        =========================== */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ===========================
           Utilities
        =========================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 600; }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        .bg-primary { background: var(--primary); }
        .bg-success { background: var(--success); }
        .bg-warning { background: var(--warning); }
        .bg-danger { background: var(--danger); }
        .bg-info { background: var(--info); }
        .hidden { display: none; }
        .visible { display: block; }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <div class="login-header">
                <div class="login-logo">
                    <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
                </div>
                <h1 class="login-title">TECSITEL</h1>
                <p class="login-subtitle">Sistema de Gestión Empresarial v3.0</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span class="btn-icon">🔐</span>
                        <span class="btn-text">Iniciar Sesión</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pantalla de Carga Mejorada -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-particles" id="loadingParticles"></div>
        <div class="loading-content">
            <div class="loading-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo">
            </div>
            <h1 class="loading-title">TECSITEL</h1>
            <p class="loading-status" id="loadingStatus">Validando credenciales...</p>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="showTab('dashboard')">
                    <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel">
                </div>
                <h2 class="sidebar-title">TECSITEL</h2>
                <p class="sidebar-subtitle">Sistema de Gestión v3.0</p>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="dashboard">
                    <span class="nav-icon">📊</span><span class="nav-text">Dashboard</span>
                </button>
                <button class="nav-item" data-tab="invoices">
                    <span class="nav-icon">📄</span><span class="nav-text">Facturas</span>
                </button>
                <button class="nav-item" data-tab="accounting">
                    <span class="nav-icon">💰</span><span class="nav-text">Contabilidad</span>
                </button>
                <button class="nav-item" data-tab="advanced-accounting">
                    <span class="nav-icon">📈</span><span class="nav-text">Contabilidad Pro</span>
                </button>
                <button class="nav-item" data-tab="personnel">
                    <span class="nav-icon">👥</span><span class="nav-text">Personal</span>
                </button>
                <button class="nav-item" data-tab="payroll">
                    <span class="nav-icon">💼</span><span class="nav-text">Planilla</span>
                </button>
                <button class="nav-item" data-tab="compliance">
                    <span class="nav-icon">⚖️</span><span class="nav-text">Cumplimiento</span>
                </button>
                <button class="nav-item" data-tab="admin-panel">
                    <span class="nav-icon">⚙️</span><span class="nav-text">Administración</span>
                </button>
                <button class="nav-item" data-tab="sharepoint">
                    <span class="nav-icon">☁️</span><span class="nav-text">Respaldos</span>
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" style="display:none;" onclick="document.getElementById('sidebar').classList.toggle('active')">☰</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="header-right">
                    <span id="userNameDisplay" style="margin-right: 10px;">Admin</span>
                    <div class="user-avatar" id="userAvatar" onclick="logout()">A</div>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="totalIncome">S/ 0.00</div><div class="stat-label">Ingresos Totales</div></div><div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">💰</div></div></div>
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="pendingInvoices">0</div><div class="stat-label">Facturas Pendientes</div></div><div class="stat-icon" style="background:var(--warning-alpha);color:var(--warning)">📋</div></div></div>
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="totalExpenses">S/ 0.00</div><div class="stat-label">Egresos</div></div><div class="stat-icon" style="background:var(--danger-alpha);color:var(--danger)">💳</div></div></div>
                        <div class="stat-card"><div class="stat-header"><div class="stat-info"><div class="stat-value" id="netBalance">S/ 0.00</div><div class="stat-label">Balance Neto</div></div><div class="stat-icon" style="background:var(--info-alpha);color:var(--info)">📈</div></div></div>
                    </div>
                    <div class="panel">
                         <div class="panel-header">
                            <h3 class="panel-title">📊 Actividad Reciente</h3>
                            <button class="btn btn-primary" onclick="showModal('newInvoice')">
                                <span class="btn-icon">➕</span>
                                <span class="btn-text">Nueva Factura</span>
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="alert alert-info">
                                <span class="alert-icon">ℹ️</span>
                                <div class="alert-content">
                                    <strong>Sistema Actualizado</strong>
                                    Cumpliendo con normativas SUNAT, SUNAFIL y MINTRA. Seguridad mejorada.
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="dashboardTable">
                                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Monto</th><th>Estado</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoices Tab -->
                <div id="invoices" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">📄 Gestión de Facturas Electrónicas</h3>
                            <button class="btn btn-primary" onclick="showModal('newInvoice')">➕ Nueva Factura</button>
                        </div>
                        <div class="panel-body">
                           <div class="alert alert-info">
                               <span class="alert-icon">ℹ️</span>
                               <div class="alert-content">
                                   <strong>Facturación Electrónica 3.0</strong>
                                   Cumple con las últimas normativas SUNAT. Genera XML y PDF automáticamente.
                               </div>
                           </div>
                           <div class="table-responsive">
                               <table class="table" id="invoicesTable">
                                   <thead><tr><th>N° Factura</th><th>Cliente</th><th>RUC</th><th>Fecha</th><th>Moneda</th><th>Monto</th><th>Estado</th><th>Acciones</th></tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Accounting Tab -->
                <div id="accounting" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">💰 Contabilidad Básica</h3>
                        </div>
                        <div class="panel-body">
                           <div class="balance-sheet">
                                <div class="balance-section">
                                    <h4>ACTIVOS</h4>
                                    <div class="balance-item"><span>Efectivo y Equivalentes</span><span id="cashBalance">S/ 25,000.00</span></div>
                                    <div class="balance-item"><span>Cuentas por Cobrar</span><span id="receivables">S/ 8,500.00</span></div>
                                    <div class="balance-item"><span>Inventarios</span><span id="inventory">S/ 12,000.00</span></div>
                                    <div class="balance-total"><span>Total Activos</span><span id="totalAssets">S/ 45,500.00</span></div>
                                </div>
                                <div class="balance-section">
                                    <h4>PASIVOS</h4>
                                    <div class="balance-item"><span>Cuentas por Pagar</span><span>S/ 15,200.00</span></div>
                                    <div class="balance-item"><span>Tributos por Pagar</span><span id="taxesPayable">S/ 10,150.00</span></div>
                                    <div class="balance-total"><span>Total Pasivos</span><span id="totalLiabilities">S/ 25,350.00</span></div>
                                </div>
                           </div>
                           <div class="balance-sheet" style="margin-top: 20px;">
                                <div class="balance-section">
                                    <h4>PATRIMONIO</h4>
                                    <div class="balance-item"><span>Capital Social</span><span>S/ 15,000.00</span></div>
                                    <div class="balance-item"><span>Utilidades Retenidas</span><span id="retainedEarnings">S/ 5,150.00</span></div>
                                    <div class="balance-total"><span>Total Patrimonio</span><span id="totalEquity">S/ 20,150.00</span></div>
                                </div>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Accounting Tab -->
                <div id="advanced-accounting" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">📈 Contabilidad Avanzada</h3>
                            <button class="btn btn-primary" onclick="showModal('newAccountingEntry')">
                                ➕ Nuevo Asiento
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="accounting-dashboard">
                                <div class="balance-cards">
                                    <div class="balance-card">
                                        <h4>Balance de Comprobación</h4>
                                        <button class="btn btn-secondary" onclick="generateBalanceSheet()">
                                            📋 Generar
                                        </button>
                                    </div>
                                    <div class="balance-card">
                                        <h4>Estado de Resultados</h4>
                                        <button class="btn btn-secondary" onclick="generateIncomeStatement()">
                                            📈 Generar
                                        </button>
                                    </div>
                                    <div class="balance-card">
                                        <h4>Exportar PLE</h4>
                                        <button class="btn btn-success" onclick="exportPLE()">
                                            📤 Exportar SUNAT
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table" id="accountingEntriesTable">
                                        <thead>
                                            <tr>
                                                <th>Número</th>
                                                <th>Fecha</th>
                                                <th>Glosa</th>
                                                <th>Debe</th>
                                                <th>Haber</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personnel Tab -->
                <div id="personnel" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">👥 Gestión de Empleados</h3>
                            <button class="btn btn-primary" onclick="showModal('newEmployee')">➕ Nuevo Empleado</button>
                        </div>
                        <div class="panel-body">
                           <div class="table-responsive">
                               <table class="table" id="employeesTable">
                                   <thead><tr><th>DNI</th><th>Nombre Completo</th><th>Estado</th><th>Acciones</th></tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">⏰ Control de Asistencia Digital</h3>
                            <button class="btn btn-primary" onclick="showModal('timeEntry')">➕ Nueva Marcación</button>
                        </div>
                        <div class="panel-body">
                           <div class="alert alert-info"><span class="alert-icon">ℹ️</span><div class="alert-content"><strong>Cumplimiento SUNAFIL.</strong> El registro de control de asistencia es obligatorio.</div></div>
                           <div class="table-responsive">
                               <table class="table" id="timeTrackingTable">
                                   <thead><tr><th>Trabajador</th><th>Entrada</th><th>Salida</th><th>Estado</th><th>Acciones</th></tr></thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Payroll Tab -->
                <div id="payroll" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">💼 Gestión de Planilla</h3>
                            <button class="btn btn-primary" onclick="showModal('calculatePayroll')">
                                🧮 Calcular Planilla
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="payroll-dashboard">
                                <div class="payroll-summary">
                                    <div class="summary-card">
                                        <h4>Empleados Activos</h4>
                                        <span id="activeEmployeesCount">0</span>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Planilla Mensual</h4>
                                        <span id="monthlyPayroll">S/ 0.00</span>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Aportes Empleador</h4>
                                        <span id="employerContributions">S/ 0.00</span>
                                    </div>
                                </div>
                                <div class="payroll-actions">
                                    <button class="btn btn-success" onclick="generatePayslips()">
                                        📄 Generar Boletas
                                    </button>
                                    <button class="btn btn-info" onclick="exportPLAME()">
                                        📊 Exportar PLAME
                                    </button>
                                    <button class="btn btn-warning" onclick="exportTRegister()">
                                        📋 Exportar T-Registro
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table" id="payrollTable">
                                        <thead>
                                            <tr>
                                                <th>Empleado</th>
                                                <th>Sueldo Básico</th>
                                                <th>Total Ingresos</th>
                                                <th>Total Descuentos</th>
                                                <th>Neto</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Tab -->
                <div id="compliance" class="tab-content">
                     <div class="compliance-grid">
                        <div class="compliance-card">
                            <div class="compliance-header"><div class="compliance-icon" style="background:rgba(16,185,129,.1)">🏛️</div><div class="compliance-info"><h3>SUNAT</h3><p>Superintendencia Nacional</p></div></div>
                            <div class="compliance-list"><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Facturación Electrónica 3.0</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Libros Electrónicos al día</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--warning)">!</div><span>PDT 621 - Vence en 10 días</span></div></div>
                            <div class="compliance-progress"><div class="progress-header"><span>Cumplimiento</span><strong>95%</strong></div><div class="progress"><div class="progress-bar" style="width:95%;background:var(--success)"></div></div></div>
                        </div>
                        <div class="compliance-card">
                            <div class="compliance-header"><div class="compliance-icon" style="background:rgba(59,130,246,.1)">⚖️</div><div class="compliance-info"><h3>SUNAFIL</h3><p>Fiscalización Laboral</p></div></div>
                            <div class="compliance-list"><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>T-REGISTRO actualizado</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Control de asistencia digital</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--warning)">!</div><span>Planillas pendientes</span></div></div>
                            <div class="compliance-progress"><div class="progress-header"><span>Cumplimiento</span><strong>88%</strong></div><div class="progress"><div class="progress-bar" style="width:88%;background:var(--warning)"></div></div></div>
                        </div>
                        <div class="compliance-card">
                            <div class="compliance-header"><div class="compliance-icon" style="background:rgba(245,158,11,.1)">🏢</div><div class="compliance-info"><h3>MINTRA</h3><p>Ministerio de Trabajo</p></div></div>
                            <div class="compliance-list"><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>PLAME presentado</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Contratos registrados</span></div><div class="compliance-item"><div class="check-icon" style="background:var(--success)">✓</div><span>Seguridad y salud</span></div></div>
                            <div class="compliance-progress"><div class="progress-header"><span>Cumplimiento</span><strong>100%</strong></div><div class="progress"><div class="progress-bar" style="width:100%;background:var(--success)"></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel Tab -->
                <div id="admin-panel" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">⚙️ Panel de Administración</h3>
                        </div>
                        <div class="panel-body">
                            <div class="admin-grid">
                                <div class="admin-section">
                                    <h4>👥 Gestión de Usuarios</h4>
                                    <div class="admin-actions">
                                        <button class="btn btn-primary" onclick="showModal('newUser')">
                                            ➕ Nuevo Usuario
                                        </button>
                                        <button class="btn btn-secondary" onclick="showUserRoles()">
                                            🔐 Roles y Permisos
                                        </button>
                                    </div>
                                </div>
                                <div class="admin-section">
                                    <h4>🏢 Configuración Empresa</h4>
                                    <div class="admin-actions">
                                        <button class="btn btn-primary" onclick="showModal('companyConfig')">
                                            ⚙️ Configurar
                                        </button>
                                        <button class="btn btn-info" onclick="showTaxConfig()">
                                            💰 Parámetros Fiscales
                                        </button>
                                    </div>
                                </div>
                                <div class="admin-section">
                                    <h4>📊 Auditoría</h4>
                                    <div class="admin-actions">
                                        <button class="btn btn-warning" onclick="showAuditLogs()">
                                            📋 Ver Logs
                                        </button>
                                        <button class="btn btn-success" onclick="exportAuditReport()">
                                            📤 Exportar Reporte
                                        </button>
                                    </div>
                                </div>
                                <div class="admin-section">
                                    <h4>🔄 Respaldos Avanzados</h4>
                                    <div class="admin-actions">
                                        <button class="btn btn-success" onclick="scheduleBackup()">
                                            ⏰ Programar Respaldo
                                        </button>
                                        <button class="btn btn-primary" onclick="downloadAdvancedBackup()">
                                            💾 Respaldo Completo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SharePoint Tab -->
                <div id="sharepoint" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">☁️ Centro de Respaldos</h3>
                        </div>
                        <div class="panel-body">
                            <div class="alert alert-success">
                                <span class="alert-icon">✅</span>
                                <div class="alert-content">
                                    <strong>Respaldos Seguros</strong>
                                    Todos los datos se almacenan localmente y se pueden exportar fácilmente.
                                </div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="backupSize">2.5 MB</div>
                                            <div class="stat-label">Tamaño de Datos</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--info-alpha);color:var(--info)">💾</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="lastBackup">Hoy</div>
                                            <div class="stat-label">Último Respaldo</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">📅</div>
                                    </div>
                                </div>
                            </div>
                            <div class="backup-actions" style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 25px;">
                                <button class="btn btn-primary" onclick="downloadFullBackup()">
                                    <span class="btn-icon">📥</span>
                                    <span class="btn-text">Descargar CSV Completo</span>
                                </button>
                                <button class="btn btn-success" onclick="downloadJSONBackup()">
                                    <span class="btn-icon">📊</span>
                                    <span class="btn-text">Descargar JSON</span>
                                </button>
                                <button class="btn btn-info" onclick="generatePDFReport()">
                                    <span class="btn-icon">📄</span>
                                    <span class="btn-text">Generar PDF</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales -->
    
    <!-- Modal Nueva Factura -->
    <div class="modal" id="newInvoice">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📄 Nueva Factura Electrónica</h3>
                <span class="close" onclick="hideModal('newInvoice')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <div class="form-group">
                        <label>RUC Cliente:</label>
                        <input type="text" id="clientRuc" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre Cliente:</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Moneda:</label>
                        <select id="currency" required>
                            <option value="PEN">PEN - Soles</option>
                            <option value="USD">USD - Dólares</option>
                            <option value="EUR">EUR - Euros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Monto (sin IGV):</label>
                        <input type="number" id="amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isExport"> Es exportación (exento de IGV)
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('newInvoice')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Factura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Empleado -->
    <div class="modal" id="newEmployee">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👥 Nuevo Empleado</h3>
                <span class="close" onclick="hideModal('newEmployee')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <div class="form-group">
                        <label>DNI:</label>
                        <input type="text" id="employeeDni" maxlength="8" required>
                    </div>
                    <div class="form-group">
                        <label>Nombres:</label>
                        <input type="text" id="employeeFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Apellidos:</label>
                        <input type="text" id="employeeLastName" required>
                    </div>
                    <div class="form-group">
                        <label>Estado:</label>
                        <select id="employeeStatus" required>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                            <option value="Vacaciones">Vacaciones</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notas:</label>
                        <textarea id="employeeNotes" rows="3"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('newEmployee')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Empleado</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Registro de Tiempo -->
    <div class="modal" id="timeEntry">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⏰ Registro de Asistencia</h3>
                <span class="close" onclick="hideModal('timeEntry')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="timeEntryForm">
                    <div class="form-group">
                        <label>Empleado:</label>
                        <select id="employeeSelect" required onchange="loadTimeEntryForEmployee(this.value)">
                            <option value="">Seleccionar empleado...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Hora de Entrada:</label>
                        <input type="time" id="entryTime" required>
                    </div>
                    <div class="form-group">
                        <label>Hora de Salida:</label>
                        <input type="time" id="exitTime">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('timeEntry')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Registro</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Asiento Contable -->
    <div class="modal" id="newAccountingEntry">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📊 Nuevo Asiento Contable</h3>
                <span class="close" onclick="hideModal('newAccountingEntry')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="accountingEntryForm">
                    <div class="form-group">
                        <label>Número de Asiento:</label>
                        <input type="text" id="entryNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Glosa:</label>
                        <input type="text" id="entryDescription" required>
                    </div>
                    <div class="accounting-details">
                        <h4>Detalle del Asiento</h4>
                        <div id="accountingDetails">
                            <div class="detail-row">
                                <select class="account-select" required>
                                    <option value="">Seleccionar cuenta...</option>
                                </select>
                                <input type="number" step="0.01" placeholder="Debe" class="debe-input">
                                <input type="number" step="0.01" placeholder="Haber" class="haber-input">
                                <button type="button" onclick="addAccountingDetail()">➕</button>
                            </div>
                        </div>
                        <div class="totals">
                            <span>Total Debe: <span id="totalDebe">0.00</span></span>
                            <span>Total Haber: <span id="totalHaber">0.00</span></span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('newAccountingEntry')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Asiento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Configuración Empresa -->
    <div class="modal" id="companyConfig">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🏢 Configuración de Empresa</h3>
                <span class="close" onclick="hideModal('companyConfig')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="companyConfigForm">
                    <div class="form-group">
                        <label>RUC:</label>
                        <input type="text" id="companyRuc" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label>Razón Social:</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Dirección:</label>
                        <input type="text" id="companyAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Teléfono:</label>
                        <input type="text" id="companyPhone">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="companyEmail">
                    </div>
                    <div class="form-group">
                        <label>Actividad Económica:</label>
                        <input type="text" id="companyActivity">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('companyConfig')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Módulos JavaScript integrados -->
    <script src="modules/advanced-modules.js"></script>
    
    <script>
    // ========================================
    // CONFIGURACIÓN Y ESTADO GLOBAL
    // ========================================
    const CONFIG = {
        IGV_RATE: 0.18,
        DEFAULT_CURRENCY: 'PEN',
        API_URL: '/.netlify/functions/api',
        VERSION: '3.0.1'
    };

    let AppState = {
        invoices: JSON.parse(localStorage.getItem('tecsitel_invoices') || '[]'),
        employees: JSON.parse(localStorage.getItem('tecsitel_employees') || '[]'),
        timeEntries: JSON.parse(localStorage.getItem('tecsitel_timeEntries') || '[]'),
        invoiceCounter: parseInt(localStorage.getItem('tecsitel_invoiceCounter') || '1'),
        currentUser: null,
        isAuthenticated: false
    };

    let currentUser = { name: 'Admin', role: 'administrador' };

    // ========================================
    // SISTEMA DE AUTENTICACIÓN
    // ========================================
    function login(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        showLoadingScreen();
        
        setTimeout(() => {
            if ((username === 'admin' && password === 'admin123') || 
                (username === 'demo' && password === 'demo')) {
                
                AppState.currentUser = { username, role: 'administrador' };
                AppState.isAuthenticated = true;
                currentUser = AppState.currentUser;
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
                document.getElementById('userNameDisplay').textContent = username;
                document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                
                initializeApp();
                showToast('✅ Sesión iniciada correctamente', 'success');
            } else {
                hideLoadingScreen();
                showToast('❌ Credenciales incorrectas', 'error');
            }
        }, 2000);
    }

    function logout() {
        AppState.isAuthenticated = false;
        AppState.currentUser = null;
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        showToast('👋 Sesión cerrada', 'info');
    }

    function showLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingStatus = document.getElementById('loadingStatus');
        
        loadingScreen.style.display = 'flex';
        
        const statuses = [
            'Validando credenciales...',
            'Cargando módulos...',
            'Sincronizando datos...',
            'Preparando dashboard...',
            'Listo!'
        ];
        
        let i = 0;
        const interval = setInterval(() => {
            if (i < statuses.length) {
                loadingStatus.textContent = statuses[i];
                i++;
            } else {
                clearInterval(interval);
            }
        }, 400);
    }

    function hideLoadingScreen() {
        document.getElementById('loadingScreen').style.display = 'none';
    }

    // ========================================
    // SISTEMA DE NAVEGACIÓN
    // ========================================
    function showTab(tabName) {
        // Ocultar todas las pestañas
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remover clase activa de botones de navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Mostrar pestaña seleccionada
        const targetTab = document.getElementById(tabName);
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // Activar botón de navegación
        const navButton = document.querySelector(`[data-tab="${tabName}"]`);
        if (navButton) {
            navButton.classList.add('active');
        }
        
        // Actualizar título de página
        const titles = {
            dashboard: 'Dashboard',
            invoices: 'Facturas',
            accounting: 'Contabilidad',
            'advanced-accounting': 'Contabilidad Pro',
            personnel: 'Personal',
            payroll: 'Planilla',
            compliance: 'Cumplimiento',
            'admin-panel': 'Administración',
            sharepoint: 'Respaldos'
        };
        
        document.getElementById('pageTitle').textContent = titles[tabName] || 'Sistema';
        
        // Actualizar datos según la pestaña
        if (tabName === 'dashboard') updateDashboard();
        if (tabName === 'invoices') renderInvoices();
        if (tabName === 'personnel') renderEmployees();
        if (tabName === 'payroll') updatePayrollSummary();
    }

    // ========================================
    // SISTEMA DE MODALES
    // ========================================
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            
            // Preparar formularios específicos
            if (modalId === 'timeEntry') {
                populateEmployeeSelect();
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            }
            
            if (modalId === 'newAccountingEntry') {
                loadAccountingPlan();
            }
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            
            // Limpiar formularios
            const form = modal.querySelector('form');
            if (form) form.reset();
        }
    }

    // ========================================
    // SISTEMA DE NOTIFICACIONES
    // ========================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        
        const icons = {
            info: 'ℹ️',
            success: '✅',
            error: '❌',
            warning: '⚠️'
        };
        
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span class="toast-icon">${icons[type]}</span>
            <span class="toast-message">${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 300);
        }, 3000);
    }

    // ========================================
    // GESTIÓN DE FACTURAS
    // ========================================
    function submitInvoice(event) {
        event.preventDefault();
        
        const formData = {
            id: Date.now(),
            invoice_number: `F001-${String(AppState.invoiceCounter).padStart(8, '0')}`,
            clientRuc: document.getElementById('clientRuc').value,
            clientName: document.getElementById('clientName').value,
            currency: document.getElementById('currency').value,
            amount: parseFloat(document.getElementById('amount').value),
            isExport: document.getElementById('isExport').checked,
            date: new Date().toISOString().split('T')[0],
            status: 'Emitida'
        };
        
        // Validaciones
        if (!validateRUC(formData.clientRuc)) {
            showToast('❌ RUC inválido', 'error');
            return;
        }
        
        AppState.invoices.push(formData);
        AppState.invoiceCounter++;
        
        saveToStorage();
        renderInvoices();
        updateDashboard();
        hideModal('newInvoice');
        
        showToast('✅ Factura creada correctamente', 'success');
    }

    function renderInvoices() {
        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';
        
        AppState.invoices.forEach(invoice => {
            const row = tbody.insertRow();
            const total = invoice.isExport ? invoice.amount : invoice.amount * (1 + CONFIG.IGV_RATE);
            
            row.innerHTML = `
                <td>${invoice.invoice_number}</td>
                <td>${invoice.clientName}</td>
                <td>${invoice.clientRuc}</td>
                <td>${invoice.date}</td>
                <td>${invoice.currency}</td>
                <td>${invoice.currency} ${total.toFixed(2)}</td>
                <td><span class="badge ${invoice.status === 'Emitida' ? 'success' : 'warning'}">${invoice.status}</span></td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="downloadInvoice(${invoice.id})">📄 Descargar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem(AppState.invoices, ${invoice.id}, 'id', renderInvoices, updateDashboard)">🗑️</button>
                </td>
            `;
        });
    }

    // ========================================
    // GESTIÓN DE EMPLEADOS
    // ========================================
    function submitEmployee(event) {
        event.preventDefault();
        
        const formData = {
            dni: document.getElementById('employeeDni').value,
            firstName: document.getElementById('employeeFirstName').value,
            lastName: document.getElementById('employeeLastName').value,
            status: document.getElementById('employeeStatus').value,
            notes: document.getElementById('employeeNotes').value
        };
        
        // Validar DNI
        if (!validateDNI(formData.dni)) {
            showToast('❌ DNI inválido', 'error');
            return;
        }
        
        // Verificar duplicados
        if (AppState.employees.find(emp => emp.dni === formData.dni)) {
            showToast('❌ Ya existe un empleado con este DNI', 'error');
            return;
        }
        
        AppState.employees.push(formData);
        saveToStorage();
        renderEmployees();
        updatePayrollSummary();
        hideModal('newEmployee');
        
        showToast('✅ Empleado agregado correctamente', 'success');
    }

    function renderEmployees() {
        const tbody = document.querySelector('#employeesTable tbody');
        tbody.innerHTML = '';
        
        AppState.employees.forEach(employee => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${employee.dni}</td>
                <td>${employee.firstName} ${employee.lastName}</td>
                <td><span class="badge ${employee.status === 'Activo' ? 'success' : 'warning'}">${employee.status}</span></td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="editEmployee('${employee.dni}')">✏️ Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem(AppState.employees, '${employee.dni}', 'dni', renderEmployees, updatePayrollSummary)">🗑️</button>
                </td>
            `;
        });
        
        // Actualizar select de empleados en formulario de asistencia
        populateEmployeeSelect();
    }

    function populateEmployeeSelect() {
        const select = document.getElementById('employeeSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">Seleccionar empleado...</option>';
        
        AppState.employees.filter(emp => emp.status === 'Activo').forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.dni;
            option.textContent = `${employee.firstName} ${employee.lastName}`;
            select.appendChild(option);
        });
    }

    // ========================================
    // CONTROL DE ASISTENCIA
    // ========================================
    function submitTimeEntry(event) {
        event.preventDefault();
        
        const employeeDni = document.getElementById('employeeSelect').value;
        const date = document.getElementById('entryDate').value;
        const entryTime = document.getElementById('entryTime').value;
        const exitTime = document.getElementById('exitTime').value;
        
        const employee = AppState.employees.find(emp => emp.dni === employeeDni);
        if (!employee) {
            showToast('❌ Empleado no encontrado', 'error');
            return;
        }
        
        // Verificar si ya existe registro para esa fecha
        const existingIndex = AppState.timeEntries.findIndex(entry => 
            entry.dni === employeeDni && entry.date === date
        );
        
        const timeEntry = {
            id: existingIndex >= 0 ? AppState.timeEntries[existingIndex].id : Date.now(),
            dni: employeeDni,
            name: `${employee.firstName} ${employee.lastName}`,
            date: date,
            entryTime: entryTime,
            exitTime: exitTime
        };
        
        if (existingIndex >= 0) {
            AppState.timeEntries[existingIndex] = timeEntry;
            showToast('✅ Registro de asistencia actualizado', 'success');
        } else {
            AppState.timeEntries.push(timeEntry);
            showToast('✅ Registro de asistencia guardado', 'success');
        }
        
        saveToStorage();
        renderTimeEntries();
        hideModal('timeEntry');
    }

    function renderTimeEntries() {
        const tbody = document.querySelector('#timeTrackingTable tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        AppState.timeEntries.slice(-20).reverse().forEach(entry => {
            const row = tbody.insertRow();
            const status = entry.exitTime ? 'Completo' : 'En progreso';
            
            row.innerHTML = `
                <td>${entry.name}</td>
                <td>${entry.entryTime}</td>
                <td>${entry.exitTime || 'Pendiente'}</td>
                <td><span class="badge ${entry.exitTime ? 'success' : 'warning'}">${status}</span></td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="editTimeEntry(${entry.id})">✏️ Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem(AppState.timeEntries, ${entry.id}, 'id', renderTimeEntries)">🗑️</button>
                </td>
            `;
        });
    }

    // ========================================
    // DASHBOARD Y ESTADÍSTICAS
    // ========================================
    function updateDashboard() {
        const totalIncome = AppState.invoices.reduce((sum, inv) => {
            const amount = inv.isExport ? inv.amount : inv.amount * (1 + CONFIG.IGV_RATE);
            return sum + amount;
        }, 0);
        
        const pendingInvoices = AppState.invoices.filter(inv => inv.status === 'Pendiente').length;
        const totalExpenses = totalIncome * 0.3; // Simulado
        const netBalance = totalIncome - totalExpenses;
        
        document.getElementById('totalIncome').textContent = `S/ ${totalIncome.toFixed(2)}`;
        document.getElementById('pendingInvoices').textContent = pendingInvoices;
        document.getElementById('totalExpenses').textContent = `S/ ${totalExpenses.toFixed(2)}`;
        document.getElementById('netBalance').textContent = `S/ ${netBalance.toFixed(2)}`;
        
        renderDashboardTable();
    }

    function renderDashboardTable() {
        const tbody = document.querySelector('#dashboardTable tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Mostrar últimas 10 transacciones
        const recentItems = [
            ...AppState.invoices.slice(-5).map(inv => ({
                date: inv.date,
                type: 'Factura',
                description: `${inv.invoice_number} - ${inv.clientName}`,
                amount: inv.isExport ? inv.amount : inv.amount * (1 + CONFIG.IGV_RATE),
                status: inv.status
            })),
            ...AppState.employees.slice(-3).map(emp => ({
                date: new Date().toISOString().split('T')[0],
                type: 'Empleado',
                description: `${emp.firstName} ${emp.lastName}`,
                amount: 0,
                status: emp.status
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
        
        recentItems.forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${item.date}</td>
                <td>${item.type}</td>
                <td>${item.description}</td>
                <td>S/ ${item.amount.toFixed(2)}</td>
                <td><span class="badge ${item.status === 'Emitida' || item.status === 'Activo' ? 'success' : 'warning'}">${item.status}</span></td>
            `;
        });
    }

    function updatePayrollSummary() {
        const activeEmployees = AppState.employees.filter(emp => emp.status === 'Activo').length;
        const monthlyPayroll = activeEmployees * 1025; // RMV base
        const employerContributions = monthlyPayroll * 0.09; // EsSalud
        
        const activeCount = document.getElementById('activeEmployeesCount');
        const monthly = document.getElementById('monthlyPayroll');
        const contributions = document.getElementById('employerContributions');
        
        if (activeCount) activeCount.textContent = activeEmployees;
        if (monthly) monthly.textContent = `S/ ${monthlyPayroll.toFixed(2)}`;
        if (contributions) contributions.textContent = `S/ ${employerContributions.toFixed(2)}`;
    }

    // ========================================
    // UTILIDADES Y VALIDACIONES
    // ========================================
    function validateRUC(ruc) {
        if (!/^\d{11}$/.test(ruc)) return false;
        
        const weights = [5, 4, 3, 2, 7, 6, 5, 4, 3, 2];
        const sum = weights.reduce((acc, weight, i) => acc + weight * parseInt(ruc[i]), 0);
        const remainder = sum % 11;
        const checkDigit = remainder < 2 ? remainder : 11 - remainder;
        
        return checkDigit === parseInt(ruc[10]);
    }

    function validateDNI(dni) {
        return /^\d{8}$/.test(dni);
    }

    function saveToStorage() {
        localStorage.setItem('tecsitel_invoices', JSON.stringify(AppState.invoices));
        localStorage.setItem('tecsitel_employees', JSON.stringify(AppState.employees));
        localStorage.setItem('tecsitel_timeEntries', JSON.stringify(AppState.timeEntries));
        localStorage.setItem('tecsitel_invoiceCounter', AppState.invoiceCounter.toString());
    }

    function deleteItem(itemArray, id, idKey, ...renderFunctions) {
        if (!confirm('¿Está seguro de que desea eliminar este registro?')) {
                return;
        }

        const index = itemArray.findIndex(item => String(item[idKey]) === String(id));
        
        if (index > -1) {
            itemArray.splice(index, 1);
            renderFunctions.forEach(fn => fn());
            showToast('Registro eliminado correctamente.', 'success');
        } else {
            showToast('No se pudo encontrar el registro para eliminar.', 'error');
        }
    }

    function downloadInvoice(invoiceId) {
        const invoice = AppState.invoices.find(inv => inv.id === invoiceId);
        if (invoice && invoice.file) {
             showToast(`Simulando descarga de: ${invoice.file}...`, 'info');
        } else {
            // Generar PDF simple de factura
            generateInvoicePDF(invoice);
        }
    }
    
    function handleFileUpload(files) {
        for (const file of files) {
            showToast(`Archivo "${file.name}" subido.`, 'success');
        }
    }

    function loadTimeEntryForEmployee(dni) {
        const form = document.getElementById('timeEntryForm');
        const date = form.entryDate.value;
        const entry = AppState.timeEntries.find(e => e.dni === dni && e.date === date);

        form.entryTime.value = entry ? entry.entryTime : '';
        form.exitTime.value = entry ? entry.exitTime : '';
    }

    // ========================================
    // Funciones de Exportación Mejoradas
    // ========================================
    function downloadFullBackup() {
        showToast('📥 Generando respaldo completo...', 'info');

        const toCsv = (data, headers) => {
            const headerRow = headers.join(',') + '\n';
            const dataRows = data.map(row => 
                headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : `"${String(row[header]).replace(/"/g, '""')}"`;
                    return cell;
                }).join(',')
            ).join('\n');
            return headerRow + dataRows;
        };

        let fullCsv = 'RESPALDO TECSITEL - ' + new Date().toLocaleDateString() + '\n\n';
        
        fullCsv += 'SECCIÓN: FACTURAS\n';
        const invoiceHeaders = ['id', 'invoice_number', 'clientRuc', 'clientName', 'currency', 'amount', 'status', 'isExport', 'date'];
        fullCsv += toCsv(AppState.invoices, invoiceHeaders) + '\n\n';

        fullCsv += 'SECCIÓN: EMPLEADOS\n';
        const employeeHeaders = ['dni', 'firstName', 'lastName', 'status', 'notes'];
        fullCsv += toCsv(AppState.employees, employeeHeaders) + '\n\n';

        fullCsv += 'SECCIÓN: REGISTRO DE ASISTENCIA\n';
        const timeEntryHeaders = ['id', 'dni', 'name', 'date', 'entryTime', 'exitTime'];
        fullCsv += toCsv(AppState.timeEntries, timeEntryHeaders) + '\n\n';

        const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `tecsitel_respaldo_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('✅ Respaldo CSV descargado.', 'success');
    }

    function downloadJSONBackup() {
        showToast('📥 Generando respaldo JSON...', 'info');
        
        const backup = {
            version: '3.0',
            date: new Date().toISOString(),
            data: {
                invoices: AppState.invoices,
                employees: AppState.employees,
                timeEntries: AppState.timeEntries,
                invoiceCounter: AppState.invoiceCounter
            }
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `tecsitel_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('✅ Respaldo JSON descargado.', 'success');
    }

    function generatePDFReport() {
        showToast('📄 Esta función requiere una librería PDF externa.', 'info');
        // En producción, usar jsPDF o similar
    }

    function generateInvoicePDF(invoice) {
        showToast('📄 Generando PDF de factura...', 'info');
        // Simulación - en producción usar jsPDF
        const content = `
FACTURA ELECTRÓNICA
==================
N°: ${invoice.invoice_number}
Fecha: ${invoice.date}
Cliente: ${invoice.clientName}
RUC: ${invoice.clientRuc}
Monto: ${invoice.currency} ${invoice.amount.toFixed(2)}
IGV: ${invoice.isExport ? '0.00' : (invoice.amount * CONFIG.IGV_RATE).toFixed(2)}
Total: ${invoice.currency} ${(invoice.isExport ? invoice.amount : invoice.amount * (1 + CONFIG.IGV_RATE)).toFixed(2)}
        `;
        
        const blob = new Blob([content], { type: 'text/plain' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `factura_${invoice.invoice_number}.txt`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('✅ Factura descargada como TXT.', 'success');
    }

    // ========================================
    // INICIALIZACIÓN DE LA APLICACIÓN
    // ========================================
    function initializeApp() {
        // Configurar navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.getAttribute('data-tab');
                showTab(tabName);
            });
        });
        
        // Configurar formularios
        document.getElementById('loginForm').addEventListener('submit', login);
        document.getElementById('invoiceForm').addEventListener('submit', submitInvoice);
        document.getElementById('employeeForm').addEventListener('submit', submitEmployee);
        document.getElementById('timeEntryForm').addEventListener('submit', submitTimeEntry);
        
        // Configurar modales
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Cargar datos iniciales
        updateDashboard();
        renderInvoices();
        renderEmployees();
        renderTimeEntries();
        updatePayrollSummary();
        
        // Mostrar tab inicial
        showTab('dashboard');
    }

    // ========================================
    // EVENTOS DE CARGA
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si hay sesión activa
        if (AppState.isAuthenticated) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            initializeApp();
        } else {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        document.getElementById('loadingScreen').style.display = 'none';
        
        console.log('✅ Tecsitel v3.0 cargado correctamente');
    });

    // Hacer funciones disponibles globalmente
    window.showTab = showTab;
    window.showModal = showModal;
    window.hideModal = hideModal;
    