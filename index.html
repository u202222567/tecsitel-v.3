<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Tecsitel - Sistema de Gesti√≥n Empresarial Integrado con facturaci√≥n electr√≥nica, contabilidad y cumplimiento normativo">
    <meta name="author" content="Tecsitel">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#dc143c">
    
    <!-- Content Security Policy actualizada para la API -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://i.imgur.com data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.netlify.app;">
    
    <title>Tecsitel - Sistema de Gesti√≥n Empresarial v3.0</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/6XXdcPR.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/6XXdcPR.png">
    
    <style>
        /* ===========================
           Variables CSS
        =========================== */
        :root {
            --primary: #dc143c; --primary-dark: #a3102d; --white: #ffffff; --dark: #1f2937;
            --gray-100: #f9fafb; --gray-200: #f3f4f6; --gray-300: #d1d5db; --gray-600: #6b7280; --gray-700: #4b5563;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --success-alpha: rgba(16, 185, 129, 0.1); --warning-alpha: rgba(245, 158, 11, 0.1);
            --danger-alpha: rgba(239, 68, 68, 0.1); --info-alpha: rgba(59, 130, 246, 0.1);
            --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0,0,0,.25);
            --radius: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-2xl: 24px; --radius-full: 50%;
            --header-height: 70px; --sidebar-width: 280px;
            --transition: 300ms ease; --transition-slow: 500ms ease;
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; }
        body { font-family: var(--font-sans); background: var(--gray-100); color: var(--dark); overflow-x: hidden; }

        /* ===========================
           PANTALLA DE LOGIN MEJORADA
        =========================== */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 11000; transition: opacity var(--transition-slow);
        }
        
        .login-form {
            background: var(--white); padding: 40px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl); width: 90%; max-width: 420px;
            animation: slideUp 0.6s ease; position: relative; overflow: hidden;
        }
        
        .login-form::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), var(--primary));
        }
        
        .login-logo {
    width: 100px;
    height: 100px;
    margin: 0 auto 30px; /* Centra horizontalmente y a√±ade margen inferior */
    background: var(--white);
    border-radius: var(--radius-full); /* Lo hace perfectamente redondo */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.08); /* Sombra mejorada */
    position: relative;
    border: 3px solid var(--primary); /* Borde con el color primario */
}

.login-logo img {
    width: 70px; /* Tama√±o ajustado para tener un margen interior */
    height: 70px;
    object-fit: contain; /* Asegura que el logo no se deforme */
}
        
        .login-title { 
            text-align: center; font-size: 28px; font-weight: 700; 
            margin-bottom: 10px; color: var(--dark);
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-subtitle {
            text-align: center; color: var(--gray-600); 
            margin-bottom: 30px; font-size: 14px;
        }

        /* ===========================
           PANTALLA DE CARGA MEJORADA
        =========================== */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            z-index: 10000; display: none; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-particles {
            position: absolute; width: 100%; height: 100%; overflow: hidden;
        }

        .loading-particles::before,
        .loading-particles::after {
            content: ''; position: absolute; width: 300px; height: 300px;
            border-radius: 50%; background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .loading-particles::before {
            top: 20%; left: 10%; animation-delay: 0s;
        }

        .loading-particles::after {
            bottom: 20%; right: 10%; animation-delay: 3s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.1); }
        }

        .loading-content {
            position: relative; z-index: 10; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .loading-logo {
            width: 140px; height: 140px; margin: 0 auto 30px;
            border-radius: var(--radius-full); background: var(--white);
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-2xl); position: relative; overflow: hidden;
            animation: pulse 2s ease-in-out infinite;
            border: 4px solid var(--white);
        }

        .loading-logo::before {
            content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
            background: conic-gradient(var(--primary), var(--primary-dark), var(--primary));
            border-radius: var(--radius-full); padding: 3px;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor; animation: rotate 3s linear infinite; z-index: -1;
        }

        .loading-logo img {
            width: 100px; height: 100px; object-fit: contain;
            border-radius: var(--radius-full); position: relative; z-index: 2;
            background: var(--white);
            padding: 10px;
        }

        .loading-logo-text {
            font-size: 48px; font-weight: 900; color: var(--primary);
            position: relative; z-index: 2; background: var(--white);
            width: 100%; height: 100%; display: none; align-items: center; justify-content: center;
            border-radius: var(--radius-full);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 48px; font-weight: 700; color: var(--white);
            margin: 0 0 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .loading-status {
            font-size: 18px; color: rgba(255,255,255,0.9);
            margin: 0; position: relative; min-height: 25px;
        }

        .loading-dots::after {
            content: ''; animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-top: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-progress {
            width: 300px; height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px; margin-top: 30px; overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%; background: var(--white);
            border-radius: 2px; animation: progress 4s ease-in-out;
            width: 0%;
        }

        @keyframes progress {
            0% { width: 0%; }
            25% { width: 30%; }
            50% { width: 60%; }
            75% { width: 85%; }
            100% { width: 100%; }
        }

        .loading-screen.hidden {
            opacity: 0; visibility: hidden;
        }

        .loading-error {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        /* ===========================
           APP CONTAINER
        =========================== */
        .app-container { 
            display: none; min-height: 100vh; opacity: 0; 
            transition: opacity var(--transition-slow); 
        }
        .app-container.loaded { opacity: 1; display: flex; }

        .sidebar {
            width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white); position: fixed; height: 100vh; transition: all var(--transition);
            z-index: 1000; display: flex; flex-direction: column;
        }

        .sidebar-header {
            padding: 30px 20px; text-align: center;
            border-bottom: 1px solid rgba(255,255,255,.1);
        }

        .logo {
            width: 80px; height: 80px; background: var(--white); border-radius: var(--radius-xl);
            margin: 0 auto 15px; padding: 15px; cursor: pointer;
        }

        .logo img { width: 100%; height: 100%; }

        .sidebar-title { font-size: 20px; font-weight: 700; margin: 0; }
        .sidebar-subtitle { font-size: 14px; opacity: .8; margin-top: 4px; }

        .nav-menu { padding: 20px 0; flex-grow: 1; overflow-y: auto; }

        .nav-item {
            display: flex; align-items: center; gap: 15px; padding: 15px 25px;
            cursor: pointer; transition: background .2s ease, padding-left .2s ease;
            border: none; background: 0 0; color: var(--white); width: 100%;
            text-align: left; font-size: 15px;
        }

        .nav-item .nav-icon { font-size: 24px; width: 28px; text-align: center; }
        .nav-item.active, .nav-item:hover { background: rgba(255,255,255,.1); padding-left: 30px; }

        .main-content {
            margin-left: var(--sidebar-width); transition: margin-left var(--transition);
            width: calc(100% - var(--sidebar-width)); display: flex; flex-direction: column;
            min-height: 100vh;
        }

        .header {
            height: var(--header-height); background: var(--white); box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
            position: sticky; top: 0; z-index: 999;
        }

        .page-title { font-size: 24px; font-weight: 700; color: var(--dark); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .content { flex: 1; padding: 30px; background: var(--gray-100); }

        /* User menu */
        .user-menu { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 40px; height: 40px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.2s ease;
        }
        .user-avatar:hover { background: var(--primary-dark); }
        .user-info { display: flex; flex-direction: column; }

        /* Dashboard metrics */
        .dashboard-metrics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .metric-card {
            background: var(--white); padding: 20px; border-radius: var(--radius-lg);
            box-shadow: var(--shadow); transition: transform 0.2s ease;
        }
        .metric-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white); border-radius: var(--radius-lg);
            box-shadow: var(--shadow); overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px); box-shadow: var(--shadow-lg);
        }

        .stat-header {
            padding: 20px; display: flex; align-items: center; justify-content: space-between;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 24px; font-weight: 700; color: var(--dark); margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px; color: var(--gray-600);
        }

        .stat-icon {
            width: 50px; height: 50px; border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }

        /* Panels */
        .panel {
            background: var(--white); border-radius: var(--radius-lg);
            box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden;
        }

        .panel-header {
            padding: 20px 25px; border-bottom: 1px solid var(--gray-200);
            display: flex; justify-content: space-between; align-items: center;
        }

        .panel-title {
            font-size: 18px; font-weight: 600; color: var(--dark); margin: 0;
        }

        .panel-body {
            padding: 25px;
        }

        /* Tabs y contenido */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: var(--white); border-radius: var(--radius-lg);
            box-shadow: var(--shadow); margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 25px; border-bottom: 1px solid var(--gray-200);
            display: flex; justify-content: space-between; align-items: center;
        }

        .card-header h3 { font-size: 18px; font-weight: 600; color: var(--dark); }

        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .table th { background: var(--gray-100); font-weight: 600; color: var(--gray-700); }
        .table tbody tr:hover { background: var(--gray-100); }

        .badge {
            padding: 4px 8px; border-radius: var(--radius); font-size: 12px; font-weight: 600;
        }
        .badge-success { background: var(--success-alpha); color: var(--success); }
        .badge-warning { background: var(--warning-alpha); color: var(--warning); }
        .badge-danger { background: var(--danger-alpha); color: var(--danger); }
        .badge-info { background: var(--info-alpha); color: var(--info); }

        /* Alerts */
        .alert {
            padding: 15px 20px; border-radius: var(--radius); margin-bottom: 20px;
            display: flex; align-items: flex-start; gap: 10px;
        }

        .alert-info {
            background: var(--info-alpha); border-left: 4px solid var(--info);
        }

        .alert-success {
            background: var(--success-alpha); border-left: 4px solid var(--success);
        }

        .alert-warning {
            background: var(--warning-alpha); border-left: 4px solid var(--warning);
        }

        .alert-danger {
            background: var(--danger-alpha); border-left: 4px solid var(--danger);
        }

        .alert-icon {
            font-size: 20px; margin-top: 2px;
        }

        .alert-content {
            flex: 1;
        }

        /* Formularios */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300);
            border-radius: var(--radius); font-size: 14px; transition: border-color var(--transition);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 0; border-color: var(--primary);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* Botones */
        .btn {
            display: inline-flex; align-items: center; padding: 10px 16px; border: none;
            border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all var(--transition); text-decoration: none; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-600); color: var(--white); }
        .btn-secondary:hover { background: var(--gray-700); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-icon {
            font-size: 16px;
        }

        /* Modales */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-2xl); width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px; border-bottom: 1px solid var(--gray-200);
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-title {
            font-size: 18px; font-weight: 600; color: var(--dark); margin: 0;
        }

        .modal-close {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: var(--gray-600); padding: 0; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px; border-top: 1px solid var(--gray-200);
            display: flex; justify-content: flex-end; gap: 10px;
        }

        /* Compliance Grid */
        .compliance-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .compliance-card {
            background: var(--white); border-radius: var(--radius-lg);
            box-shadow: var(--shadow); overflow: hidden;
        }

        .compliance-header {
            padding: 20px; display: flex; align-items: center; gap: 15px;
        }

        .compliance-icon {
            width: 50px; height: 50px; border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }

        .compliance-info h3 {
            font-size: 18px; font-weight: 600; color: var(--dark); margin: 0;
        }

        .compliance-info p {
            font-size: 14px; color: var(--gray-600); margin: 4px 0 0;
        }

        .compliance-list {
            padding: 0 20px;
        }

        .compliance-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 0; border-bottom: 1px solid var(--gray-200);
        }

        .compliance-item:last-child {
            border-bottom: none;
        }

        .check-icon {
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px; font-weight: bold;
        }

        .compliance-progress {
            padding: 20px; border-top: 1px solid var(--gray-200);
        }

        .progress-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }

        .progress {
            height: 8px; background: var(--gray-200);
            border-radius: 4px; overflow: hidden;
        }

        .progress-bar {
            height: 100%; border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Toast notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast {
            background: var(--white); padding: 15px 20px; border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl); margin-bottom: 10px; border-left: 4px solid var(--info);
            animation: slideIn .3s ease; opacity: 1; transition: opacity .3s ease;
        }
        .toast-success { border-left-color: var(--success); }
        .toast-warning { border-left-color: var(--warning); }
        .toast-error { border-left-color: var(--danger); }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Estados de error */
        .error { border-color: var(--danger) !important; background: rgba(239,68,68,.05); }

        /* Responsive */
        @media(max-width:1024px) {
            .sidebar { transform: translateX(-100%); z-index: 1001; }
            .sidebar.active { transform: translateX(0); box-shadow: var(--shadow-2xl); }
            .main-content { margin-left: 0; width: 100%; }
            .menu-toggle { display: block !important; }
        }
        @media(max-width:768px) {
            .content { padding: 20px; }
            .header { padding: 0 20px; }
            .page-title { font-size: 20px; }
            .dashboard-metrics { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .loading-logo { width: 120px; height: 120px; }
            .loading-logo img { width: 80px; height: 80px; }
            .loading-title { font-size: 36px; }
            .loading-progress { width: 250px; }
            .form-row { grid-template-columns: 1fr; }
            .compliance-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <div class="login-logo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo" id="loginLogoImg">
            </div>
            <h2 class="login-title">TECSITEL</h2>
            <p class="login-subtitle">Sistema de Gesti√≥n Empresarial v3.0</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" class="form-input" id="username" placeholder="admin" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginButton">
                    <span id="loginButtonText">Iniciar Sesi√≥n</span>
                    <span id="loginSpinner" style="display: none;">üîÑ</span>
                </button>
                <p style="text-align: center; margin-top: 15px; color: var(--gray-600); font-size: 12px;">
                    Credenciales: <strong>admin</strong> / <strong>admin123</strong> o <strong>demo</strong> / <strong>demo</strong>
                </p>
            </form>
        </div>
    </div>

    <!-- Pantalla de Carga Mejorada -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-particles"></div>
        <div class="loading-content">
            <div class="loading-logo" id="loadingLogo">
                <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel Logo" 
                     onerror="this.style.display='none'; document.getElementById('logoText').style.display='flex';">
                <div class="loading-logo-text" id="logoText" style="display: none;">T</div>
            </div>
            <h1 class="loading-title">TECSITEL</h1>
            <p class="loading-status loading-dots" id="loadingStatus">Conectando con servidor</p>
            <div class="loading-spinner"></div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo" onclick="showTab('dashboard')">
                    <img src="https://i.imgur.com/6XXdcPR.png" alt="Tecsitel">
                </div>
                <h2 class="sidebar-title">TECSITEL</h2>
                <p class="sidebar-subtitle">Sistema de Gesti√≥n v3.0</p>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="dashboard">
                    <span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span>
                </button>
                <button class="nav-item" data-tab="invoices">
                    <span class="nav-icon">üìÑ</span><span class="nav-text">Facturas</span>
                </button>
                <button class="nav-item" data-tab="accounting">
                    <span class="nav-icon">üí∞</span><span class="nav-text">Contabilidad</span>
                </button>
                 <button class="nav-item" data-tab="personnel">
                    <span class="nav-icon">üë•</span><span class="nav-text">Personal</span>
                </button>
                <button class="nav-item" data-tab="compliance">
                    <span class="nav-icon">‚öñÔ∏è</span><span class="nav-text">Cumplimiento</span>
                </button>
                <button class="nav-item" data-tab="sharepoint">
                    <span class="nav-icon">‚òÅÔ∏è</span><span class="nav-text">Respaldos</span>
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <button class="menu-toggle" style="display:none;" onclick="document.getElementById('sidebar').classList.toggle('active')">‚ò∞</button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <span id="userNameDisplay" style="font-weight: 600; color: var(--dark);">Usuario</span>
                            <div style="font-size: 12px; color: var(--gray-600);" id="userRole">Sistema v3.0</div>
                        </div>
                        <button onclick="logout()" class="btn btn-secondary btn-sm" style="margin-left: 10px;">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-value" id="totalIncome">S/ 0.00</div>
                                    <div class="stat-label">Ingresos Totales</div>
                                </div>
                                <div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">üí∞</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-value" id="pendingInvoices">0</div>
                                    <div class="stat-label">Facturas Pendientes</div>
                                </div>
                                <div class="stat-icon" style="background:var(--warning-alpha);color:var(--warning)">üìã</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-value" id="totalExpenses">S/ 0.00</div>
                                    <div class="stat-label">Egresos</div>
                                </div>
                                <div class="stat-icon" style="background:var(--danger-alpha);color:var(--danger)">üí≥</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-info">
                                    <div class="stat-value" id="netBalance">S/ 0.00</div>
                                    <div class="stat-label">Balance Neto</div>
                                </div>
                                <div class="stat-icon" style="background:var(--info-alpha);color:var(--info)">üìà</div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üìä Actividad Reciente</h3>
                            <button class="btn btn-primary" onclick="showModal('newInvoice')">
                                <span class="btn-icon">‚ûï</span>
                                <span class="btn-text">Nueva Factura</span>
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="alert alert-info">
                                <span class="alert-icon">‚ÑπÔ∏è</span>
                                <div class="alert-content">
                                    <strong>Sistema Actualizado</strong>
                                    Cumpliendo con normativas SUNAT, SUNAFIL y MINTRA. Seguridad mejorada.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üìÑ Estado del Sistema</h3>
                            <button class="btn btn-primary btn-sm" onclick="checkSystemStatus()">Verificar Estado</button>
                        </div>
                        <div class="panel-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>API Status:</strong>
                                    <span id="apiStatus" class="badge badge-info">Verificando...</span>
                                </div>
                                <div>
                                    <strong>Base de Datos:</strong>
                                    <span id="dbStatus" class="badge badge-info">Verificando...</span>
                                </div>
                                <div>
                                    <strong>Usuario:</strong>
                                    <span id="currentUser" class="badge badge-success">Conectado</span>
                                </div>
                                <div>
                                    <strong>Sesi√≥n:</strong>
                                    <span id="sessionStatus" class="badge badge-success">Activa</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üìä Resumen Ejecutivo</h3>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="dashboardTable">
                                    <thead>
                                        <tr>
                                            <th>M√≥dulo</th>
                                            <th>Estado</th>
                                            <th>√öltima Actualizaci√≥n</th>
                                            <th>Registros</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Facturas</td>
                                            <td><span class="badge badge-success">Activo</span></td>
                                            <td id="lastFacturaUpdate">-</td>
                                            <td id="facturaCount">0</td>
                                        </tr>
                                        <tr>
                                            <td>Personal</td>
                                            <td><span class="badge badge-success">Activo</span></td>
                                            <td id="lastPersonalUpdate">-</td>
                                            <td id="personalCount">0</td>
                                        </tr>
                                        <tr>
                                            <td>Contabilidad</td>
                                            <td><span class="badge badge-success">Activo</span></td>
                                            <td id="lastContabilidadUpdate">-</td>
                                            <td>En tiempo real</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Facturas Tab -->
                <div id="invoices" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üìÑ Gesti√≥n de Facturas</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="showModal('newInvoice')">
                                    <span class="btn-icon">‚ûï</span>
                                    Nueva Factura
                                </button>
                                <button class="btn btn-success" onclick="exportInvoices()">
                                    <span class="btn-icon">üìä</span>
                                    Exportar
                                </button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="invoicesTable">
                                    <thead>
                                        <tr>
                                            <th>N¬∞ Factura</th>
                                            <th>Cliente</th>
                                            <th>RUC/DNI</th>
                                            <th>Monto</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contabilidad Tab -->
                <div id="accounting" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üí∞ M√≥dulo de Contabilidad</h3>
                            <button class="btn btn-primary" onclick="generateAccountingReport()">
                                <span class="btn-icon">üìä</span>
                                Generar Reporte
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="stats-grid" style="margin-bottom: 20px;">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="monthlyIncome">S/ 0.00</div>
                                            <div class="stat-label">Ingresos del Mes</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">üìà</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="monthlyExpenses">S/ 0.00</div>
                                            <div class="stat-label">Gastos del Mes</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--danger-alpha);color:var(--danger)">üìâ</div>
                                    </div>
                                </div>
                            </div>
                            <p>Los datos contables se sincronizan en tiempo real con PostgreSQL.</p>
                        </div>
                    </div>
                </div>

                <!-- Personal Tab -->
                <div id="personnel" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üë• Gesti√≥n de Personal</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="showModal('newEmployee')">
                                    <span class="btn-icon">‚ûï</span>
                                    Nuevo Empleado
                                </button>
                                <button class="btn btn-success" onclick="exportEmployees()">
                                    <span class="btn-icon">üìä</span>
                                    Exportar
                                </button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="table-container">
                                <table class="table" id="employeesTable">
                                    <thead>
                                        <tr>
                                            <th>DNI</th>
                                            <th>Nombre</th>
                                            <th>Apellidos</th>
                                            <th>Estado</th>
                                            <th>Fecha Ingreso</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">‚è∞ Control de Asistencia</h3>
                            <button class="btn btn-primary" onclick="showModal('timeEntry')">
                                <span class="btn-icon">‚è∞</span>
                                Registrar Asistencia
                            </button>
                        </div>
                        <div class="panel-body">
                            <div class="alert alert-warning">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <div class="alert-content">
                                    Recuerda que el registro de asistencia es obligatorio seg√∫n SUNAFIL.
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="table" id="timeTrackingTable">
                                    <thead>
                                        <tr>
                                            <th>Trabajador</th>
                                            <th>Fecha</th>
                                            <th>Entrada</th>
                                            <th>Salida</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cumplimiento Tab -->
                <div id="compliance" class="tab-content">
                    <div class="compliance-grid">
                        <div class="compliance-card">
                            <div class="compliance-header">
                                <div class="compliance-icon" style="background:rgba(16,185,129,.1)">üèõÔ∏è</div>
                                <div class="compliance-info">
                                    <h3>SUNAT</h3>
                                    <p>Superintendencia Nacional</p>
                                </div>
                            </div>
                            <div class="compliance-list">
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Facturaci√≥n Electr√≥nica 3.0</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Libros Electr√≥nicos al d√≠a</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--warning)">!</div>
                                    <span>PDT 621 - Vence en 10 d√≠as</span>
                                </div>
                            </div>
                            <div class="compliance-progress">
                                <div class="progress-header">
                                    <span>Cumplimiento</span>
                                    <strong>95%</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width:95%;background:var(--success)"></div>
                                </div>
                            </div>
                        </div>

                        <div class="compliance-card">
                            <div class="compliance-header">
                                <div class="compliance-icon" style="background:rgba(59,130,246,.1)">‚öñÔ∏è</div>
                                <div class="compliance-info">
                                    <h3>SUNAFIL</h3>
                                    <p>Fiscalizaci√≥n Laboral</p>
                                </div>
                            </div>
                            <div class="compliance-list">
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>T-REGISTRO actualizado</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Control de asistencia digital</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>SCTR vigente</span>
                                </div>
                            </div>
                            <div class="compliance-progress">
                                <div class="progress-header">
                                    <span>Cumplimiento</span>
                                    <strong>100%</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width:100%;background:var(--success)"></div>
                                </div>
                            </div>
                        </div>

                        <div class="compliance-card">
                            <div class="compliance-header">
                                <div class="compliance-icon" style="background:rgba(245,158,11,.1)">üìã</div>
                                <div class="compliance-info">
                                    <h3>MINTRA</h3>
                                    <p>Ministerio de Trabajo</p>
                                </div>
                            </div>
                            <div class="compliance-list">
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Contratos registrados</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Planilla electr√≥nica</span>
                                </div>
                                <div class="compliance-item">
                                    <div class="check-icon" style="background:var(--success)">‚úì</div>
                                    <span>Reglamento interno</span>
                                </div>
                            </div>
                            <div class="compliance-progress">
                                <div class="progress-header">
                                    <span>Cumplimiento</span>
                                    <strong>98%</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width:98%;background:var(--success)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Respaldos Tab -->
                <div id="sharepoint" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">‚òÅÔ∏è Sistema de Respaldos</h3>
                        </div>
                        <div class="panel-body">
                            <p>Genera y descarga respaldos completos de todos los datos de la aplicaci√≥n.</p>
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="downloadFullBackup()">
                                    <span class="btn-icon">üì•</span>
                                    Respaldo CSV Completo
                                </button>
                                <button class="btn btn-primary" onclick="downloadJSONBackup()">
                                    <span class="btn-icon">üíæ</span>
                                    Respaldo JSON
                                </button>
                                <button class="btn btn-warning" onclick="generatePDFReport()">
                                    <span class="btn-icon">üìÑ</span>
                                    Reporte PDF
                                </button>
                                <button class="btn btn-info" onclick="testAPIConnection()">
                                    <span class="btn-icon">üîå</span>
                                    Probar Conexi√≥n API
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">üìä Estad√≠sticas de Exportaci√≥n</h3>
                        </div>
                        <div class="panel-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="totalBackups">0</div>
                                            <div class="stat-label">Respaldos Generados</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--info-alpha);color:var(--info)">üíæ</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div class="stat-info">
                                            <div class="stat-value" id="lastBackupDate">-</div>
                                            <div class="stat-label">√öltimo Respaldo</div>
                                        </div>
                                        <div class="stat-icon" style="background:var(--success-alpha);color:var(--success)">‚è∞</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales -->

    <!-- Modal Nueva Factura -->
    <div class="modal" id="newInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Nueva Factura</h3>
                <button class="modal-close" onclick="hideModal('newInvoice')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">RUC/DNI Cliente *</label>
                            <input type="text" class="form-input" name="clientRuc" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre/Raz√≥n Social *</label>
                            <input type="text" class="form-input" name="clientName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Moneda *</label>
                            <select class="form-select" name="currency" required>
                                <option value="PEN">Soles (PEN)</option>
                                <option value="USD">D√≥lares (USD)</option>
                                <option value="EUR">Euros (EUR)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto (sin IGV) *</label>
                            <input type="number" step="0.01" class="form-input" name="amount" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="isExport" style="margin-right: 8px;">
                            Es exportaci√≥n (exonerado de IGV)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-textarea" name="description" rows="3" placeholder="Descripci√≥n del servicio o producto"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('newInvoice')">Cancelar</button>
                <button type="submit" form="invoiceForm" class="btn btn-primary">Guardar Factura</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Empleado -->
    <div class="modal" id="newEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üë• Nuevo Empleado</h3>
                <button class="modal-close" onclick="hideModal('newEmployee')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employeeForm" onsubmit="saveEmployee(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">DNI *</label>
                            <input type="text" class="form-input" name="dni" required maxlength="8" pattern="[0-9]{8}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado *</label>
                            <select class="form-select" name="status" required>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                                <option value="licencia">En Licencia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombres *</label>
                            <input type="text" class="form-input" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellidos *</label>
                            <input type="text" class="form-input" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Ingreso</label>
                        <input type="date" class="form-input" name="hireDate" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea class="form-textarea" name="notes" rows="3" placeholder="Informaci√≥n adicional"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('newEmployee')">Cancelar</button>
                <button type="submit" form="employeeForm" class="btn btn-primary">Guardar Empleado</button>
            </div>
        </div>
    </div>

    <!-- Modal Registro de Asistencia -->
    <div class="modal" id="timeEntryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚è∞ Registro de Asistencia</h3>
                <button class="modal-close" onclick="hideModal('timeEntry')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="timeEntryForm" onsubmit="saveTimeEntry(event)">
                    <div class="form-group">
                        <label class="form-label">Empleado *</label>
                        <select class="form-select" name="dni" required id="timeEntryEmployee">
                            <option value="">Seleccionar empleado...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" class="form-input" name="date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora de Entrada</label>
                            <input type="time" class="form-input" name="entryTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora de Salida</label>
                        <input type="time" class="form-input" name="exitTime">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('timeEntry')">Cancelar</button>
                <button type="submit" form="timeEntryForm" class="btn btn-primary">Guardar Registro</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ========================================
    // CONFIGURACI√ìN PARA TU API REAL
    // ========================================
    const CONFIG = {
        API_BASE_URL: '/api',
        VERSION: '3.0.1',
        IGV_RATE: 0.18,
        COMPANY: {
            NAME: 'TECSITEL EIRL',
            RUC: '20605908285'
        }
    };

    const AppState = {
        user: null,
        token: null,
        isAuthenticated: false,
        sessionStart: null,
        config: null,
        invoices: [],
        employees: [],
        timeEntries: [],
        invoiceCounter: 1,
        backupCounter: 0
    };

    let loadingTimeout;
    let currentLoadingStep = 0;

    const loadingSteps = [
        'Conectando con servidor',
        'Validando credenciales',
        'Cargando configuraci√≥n',
        'Sincronizando datos',
        'Preparando dashboard',
        'Sistema listo'
    ];

    // ========================================
    // FUNCIONES DE CARGA MEJORADAS
    // ========================================
    function startLoading() {
        const loadingScreen = document.getElementById('loadingScreen');
        const progressBar = document.getElementById('progressBar');
        
        loadingScreen.style.display = 'flex';
        loadingScreen.classList.remove('hidden', 'loading-error');
        
        currentLoadingStep = 0;
        progressBar.style.width = '0%';
        
        updateLoadingStep();
    }

    function updateLoadingStep() {
        const loadingStatus = document.getElementById('loadingStatus');
        const progressBar = document.getElementById('progressBar');
        
        if (currentLoadingStep < loadingSteps.length) {
            loadingStatus.textContent = loadingSteps[currentLoadingStep];
            
            const progress = ((currentLoadingStep + 1) / loadingSteps.length) * 100;
            progressBar.style.width = progress + '%';
            
            currentLoadingStep++;
            
            if (currentLoadingStep < loadingSteps.length) {
                loadingTimeout = setTimeout(updateLoadingStep, 800);
            } else {
                setTimeout(hideLoading, 500);
            }
        }
    }

    function hideLoading() {
        const loadingScreen = document.getElementById('loadingScreen');
        
        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
        }
        
        loadingScreen.classList.add('hidden');
        
        setTimeout(() => {
            loadingScreen.style.display = 'none';
        }, 500);
    }

    function showLoadingError(message = 'Error de conexi√≥n') {
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingStatus = document.getElementById('loadingStatus');
        
        loadingScreen.classList.add('loading-error');
        loadingStatus.textContent = message;
        loadingStatus.classList.remove('loading-dots');
        
        setTimeout(hideLoading, 3000);
    }

    // ========================================
    // FUNCIONES DE API
    // ========================================
    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': AppState.token ? `Bearer ${AppState.token}` : ''
        };
    }

    async function apiRequest(endpoint, options = {}) {
        const url = `${CONFIG.API_BASE_URL}${endpoint}`;
        const defaultOptions = {
            headers: getAuthHeaders(),
            ...options
        };

        try {
            console.log(`üåê API Request: ${options.method || 'GET'} ${url}`);
            const response = await fetch(url, defaultOptions);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Error de servidor' }));
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('‚ùå API Error:', error);
            
            // Fallback para modo demo sin API
            if (error.message.includes('fetch')) {
                console.log('üîÑ Modo demo: simulando respuesta...');
                return simulateAPIResponse(endpoint, options);
            }
            throw error;
        }
    }

    function simulateAPIResponse(endpoint, options) {
        // Simulaciones para modo demo
        if (endpoint === '/auth/login') {
            return {
                token: 'demo_token_' + Date.now(),
                user: {
                    id: 1,
                    username: 'demo',
                    name: 'Usuario Demo',
                    role: 'Administrador'
                }
            };
        }
        
        if (endpoint === '/health') {
            return {
                status: 'OK (Demo)',
                database: 'connected',
                version: CONFIG.VERSION
            };
        }
        
        return { success: true, message: 'Demo mode' };
    }

    // ========================================
    // SISTEMA DE AUTENTICACI√ìN
    // ========================================
    async function handleLogin(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showToast('‚ùå Complete todos los campos', 'error');
            return;
        }

        // Validaciones b√°sicas de credenciales
        const validCredentials = [
            { user: 'admin', pass: 'admin123' },
            { user: 'demo', pass: 'demo' }
        ];

        const isValid = validCredentials.some(cred => 
            cred.user === username && cred.pass === password
        );

        if (!isValid) {
            showToast('‚ùå Credenciales incorrectas', 'error');
            return;
        }

        // UI de loading en el bot√≥n
        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginSpinner = document.getElementById('loginSpinner');
        
        loginButton.disabled = true;
        loginButtonText.style.display = 'none';
        loginSpinner.style.display = 'inline';

        try {
            console.log('üîê Intentando login...');
            
            // Petici√≥n a tu API real
            const response = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            console.log('‚úÖ Login exitoso:', response);

            // Guardar datos de sesi√≥n
            AppState.token = response.token;
            AppState.user = response.user;
            AppState.isAuthenticated = true;
            AppState.sessionStart = Date.now();

            // Persistir en memoria (no localStorage para artifacts)
            
            // Transici√≥n a pantalla de carga
            document.getElementById('loginScreen').style.display = 'none';
            startLoading();

            showToast('‚úÖ Acceso autorizado', 'success');

            // Inicializar aplicaci√≥n
            setTimeout(initializeApp, 1500);

        } catch (error) {
            console.error('‚ùå Error de login:', error);
            showToast(`‚ùå ${error.message}`, 'error');
            
            // Marcar campos con error
            document.getElementById('username').classList.add('error');
            document.getElementById('password').classList.add('error');
            
            setTimeout(() => {
                document.getElementById('username').classList.remove('error');
                document.getElementById('password').classList.remove('error');
            }, 3000);

        } finally {
            // Restaurar bot√≥n
            loginButton.disabled = false;
            loginButtonText.style.display = 'inline';
            loginSpinner.style.display = 'none';
        }
    }

    // ========================================
    // INICIALIZACI√ìN DE LA APLICACI√ìN
    // ========================================
    async function initializeApp() {
        console.log('üöÄ Inicializando TECSITEL v3.0...');
        
        try {
            // Cargar configuraci√≥n del sistema
            await loadSystemConfig();
            
            // Cargar datos iniciales
            await loadInitialData();
            
            // Mostrar aplicaci√≥n
            setTimeout(() => {
                const appContainer = document.getElementById('appContainer');
                appContainer.style.display = 'flex';
                appContainer.classList.add('loaded');
                
                renderUserInterface();
                setupEventListeners();
                loadSampleData();
                checkSystemStatus();
                
                showToast('‚úÖ Sistema TECSITEL listo', 'success');
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Error en inicializaci√≥n:', error);
            showLoadingError('Error al cargar el sistema');
            
            // Fallback: mostrar aplicaci√≥n b√°sica
            setTimeout(() => {
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('appContainer').classList.add('loaded');
                renderUserInterface();
                setupEventListeners();
                loadSampleData();
                showToast('‚ö†Ô∏è Sistema iniciado en modo b√°sico', 'warning');
            }, 2000);
        }
    }

    async function loadSystemConfig() {
        try {
            console.log('üì° Cargando configuraci√≥n del sistema...');
            const config = await apiRequest('/config');
            AppState.config = config;
            console.log('‚úì Configuraci√≥n cargada:', config);
        } catch (error) {
            console.warn('‚ö†Ô∏è No se pudo cargar la configuraci√≥n:', error);
            AppState.config = { version: CONFIG.VERSION };
        }
    }

    async function loadInitialData() {
        try {
            console.log('üìä Cargando datos iniciales...');
            
            // Aqu√≠ puedes agregar m√°s endpoints seg√∫n tu API
            // Por ejemplo:
            // const invoices = await apiRequest('/invoices');
            // AppState.invoices = invoices.data || [];
            
            console.log('‚úì Datos iniciales cargados');
            
        } catch (error) {
            console.warn('‚ö†Ô∏è No se pudieron cargar algunos datos:', error);
        }
    }

    function loadSampleData() {
        // Datos de ejemplo para demostraci√≥n
        AppState.invoices = [
            {
                id: 1,
                invoice_number: 'F001-00000001',
                clientRuc: '20123456789',
                clientName: 'Empresa Demo S.A.C.',
                currency: 'PEN',
                amount: 1000.00,
                status: 'paid',
                isExport: false,
                date: '2025-01-10',
                description: 'Servicios de consultor√≠a'
            },
            {
                id: 2,
                invoice_number: 'F001-00000002',
                clientRuc: '12345678',
                clientName: 'Juan P√©rez Garc√≠a',
                currency: 'PEN',
                amount: 500.00,
                status: 'pending',
                isExport: false,
                date: '2025-01-09',
                description: 'Desarrollo de software'
            }
        ];

        AppState.employees = [
            {
                dni: '12345678',
                firstName: 'Mar√≠a',
                lastName: 'Garc√≠a L√≥pez',
                status: 'activo',
                hireDate: '2024-01-15',
                notes: 'Desarrolladora Senior'
            },
            {
                dni: '87654321',
                firstName: 'Carlos',
                lastName: 'Mendoza Silva',
                status: 'activo',
                hireDate: '2024-03-01',
                notes: 'Analista de Sistemas'
            }
        ];

        AppState.timeEntries = [
            {
                id: 1,
                dni: '12345678',
                name: 'Mar√≠a Garc√≠a L√≥pez',
                date: '2025-01-10',
                entryTime: '08:00',
                exitTime: '17:00'
            }
        ];

        AppState.invoiceCounter = 3;
        updateAllTables();
    }

    // ========================================
    // RENDERIZADO DE LA INTERFAZ
    // ========================================
    function renderUserInterface() {
        console.log('üé® Renderizando interfaz de usuario...');
        
        try {
            // Actualizar informaci√≥n del usuario
            if (AppState.user) {
                const userAvatar = document.getElementById('userAvatar');
                const userNameDisplay = document.getElementById('userNameDisplay');
                const userRole = document.getElementById('userRole');
                
                if (userAvatar) {
                    userAvatar.textContent = AppState.user.name?.charAt(0).toUpperCase() || 
                                           AppState.user.username?.charAt(0).toUpperCase() || 'U';
                }
                
                if (userNameDisplay) {
                    userNameDisplay.textContent = AppState.user.name || AppState.user.username || 'Usuario';
                }
                
                if (userRole) {
                    userRole.textContent = AppState.user.role || 'Sistema v3.0';
                }
            }
            
            // Actualizar m√©tricas del dashboard
            updateDashboardMetrics();
            
            // Actualizar contadores
            updateSystemCounters();
            
        } catch (error) {
            console.error('‚ùå Error en renderizado:', error);
        }
    }

    function updateDashboardMetrics() {
        // Calcular totales reales
        const totalIncome = AppState.invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.amount, 0);

        const pendingIncome = AppState.invoices
            .filter(inv => inv.status === 'pending')
            .reduce((sum, inv) => sum + inv.amount, 0);

        const pendingCount = AppState.invoices.filter(inv => inv.status === 'pending').length;

        // Actualizar elementos
        const elements = {
            'totalIncome': `S/ ${totalIncome.toFixed(2)}`,
            'pendingInvoices': pendingCount.toString(),
            'totalExpenses': 'S/ 0.00',
            'netBalance': `S/ ${totalIncome.toFixed(2)}`,
            'monthlyIncome': `S/ ${totalIncome.toFixed(2)}`,
            'monthlyExpenses': 'S/ 0.00'
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
    }

    function updateSystemCounters() {
        const now = new Date().toLocaleString();
        
        // Actualizar √∫ltima actualizaci√≥n
        const lastUpdates = ['lastFacturaUpdate', 'lastPersonalUpdate', 'lastContabilidadUpdate'];
        lastUpdates.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = now;
        });
        
        // Actualizar contadores
        if (document.getElementById('facturaCount')) {
            document.getElementById('facturaCount').textContent = AppState.invoices?.length || '0';
        }
        if (document.getElementById('personalCount')) {
            document.getElementById('personalCount').textContent = AppState.employees?.length || '0';
        }
        if (document.getElementById('totalBackups')) {
            document.getElementById('totalBackups').textContent = AppState.backupCounter.toString();
        }
        if (document.getElementById('lastBackupDate')) {
            document.getElementById('lastBackupDate').textContent = AppState.backupCounter > 0 ? now : '-';
        }
    }

    // ========================================
    // FUNCIONES DEL SISTEMA
    // ========================================
    async function checkSystemStatus() {
        console.log('üîç Verificando estado del sistema...');
        
        try {
            const health = await apiRequest('/health');
            
            // Actualizar estados en la UI
            const apiStatus = document.getElementById('apiStatus');
            const dbStatus = document.getElementById('dbStatus');
            const currentUser = document.getElementById('currentUser');
            
            if (apiStatus) {
                apiStatus.textContent = health.status || 'OK';
                apiStatus.className = 'badge badge-success';
            }
            
            if (dbStatus) {
                dbStatus.textContent = health.database || 'Conectado';
                dbStatus.className = health.database === 'connected' ? 'badge badge-success' : 'badge badge-warning';
            }
            
            if (currentUser) {
                currentUser.textContent = AppState.user?.username || 'Conectado';
            }
            
            showToast('‚úÖ Estado del sistema verificado', 'success');
            
        } catch (error) {
            console.error('‚ùå Error verificando estado:', error);
            showToast('‚ö†Ô∏è Error al verificar el estado del sistema', 'warning');
        }
    }

    async function testAPIConnection() {
        try {
            showToast('üîÑ Probando conexi√≥n con API...', 'info');
            const health = await apiRequest('/health');
            showToast(`‚úÖ API funcionando: ${health.status}`, 'success');
            console.log('API Health:', health);
        } catch (error) {
            showToast(`‚ùå Error de API: ${error.message}`, 'error');
        }
    }

    async function logout() {
        if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
            try {
                // Opcional: notificar al servidor
                if (AppState.token) {
                    await apiRequest('/auth/logout', { method: 'POST' }).catch(() => {});
                }
            } catch (error) {
                console.error('Error en logout:', error);
            }
            
            // Limpiar datos locales
            AppState.token = null;
            AppState.user = null;
            AppState.isAuthenticated = false;
            
            showToast('‚úÖ Sesi√≥n cerrada correctamente', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    }

    // ========================================
    // GESTI√ìN DE MODALES
    // ========================================
    function showModal(modalName) {
        const modal = document.getElementById(modalName + 'Modal');
        if (modal) {
            modal.classList.add('active');
            
            // Preparar datos espec√≠ficos del modal
            if (modalName === 'timeEntry') {
                populateEmployeeSelect();
                document.querySelector('#timeEntryForm [name="date"]').value = new Date().toISOString().split('T')[0];
            }
            
            if (modalName === 'newEmployee') {
                document.querySelector('#employeeForm [name="hireDate"]').value = new Date().toISOString().split('T')[0];
            }
        }
    }

    function hideModal(modalName) {
        const modal = document.getElementById(modalName + 'Modal');
        if (modal) {
            modal.classList.remove('active');
            
            // Limpiar formulario
            const form = modal.querySelector('form');
            if (form) form.reset();
        }
    }

    function populateEmployeeSelect() {
        const select = document.getElementById('timeEntryEmployee');
        if (select) {
            select.innerHTML = '<option value="">Seleccionar empleado...</option>';
            AppState.employees.forEach(emp => {
                if (emp.status === 'activo') {
                    const option = document.createElement('option');
                    option.value = emp.dni;
                    option.textContent = `${emp.firstName} ${emp.lastName} (${emp.dni})`;
                    select.appendChild(option);
                }
            });
        }
    }

    // ========================================
    // GESTI√ìN DE FACTURAS
    // ========================================
    function saveInvoice(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        const invoice = {
            id: Date.now(),
            invoice_number: `F001-${String(AppState.invoiceCounter).padStart(8, '0')}`,
            clientRuc: formData.get('clientRuc'),
            clientName: formData.get('clientName'),
            currency: formData.get('currency'),
            amount: parseFloat(formData.get('amount')),
            status: 'pending',
            isExport: formData.get('isExport') === 'on',
            date: new Date().toISOString().split('T')[0],
            description: formData.get('description')
        };

        // Validaciones b√°sicas
        if (!invoice.clientRuc || !invoice.clientName || !invoice.amount) {
            showToast('‚ùå Complete todos los campos obligatorios', 'error');
            return;
        }

        AppState.invoices.push(invoice);
        AppState.invoiceCounter++;
        
        updateInvoicesTable();
        updateDashboardMetrics();
        updateSystemCounters();
        hideModal('newInvoice');
        
        showToast('‚úÖ Factura creada correctamente', 'success');
    }

    function updateInvoicesTable() {
        const tbody = document.querySelector('#invoicesTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        AppState.invoices.forEach(invoice => {
            const row = document.createElement('tr');
            
            const statusBadge = invoice.status === 'paid' ? 
                '<span class="badge badge-success">Pagada</span>' : 
                '<span class="badge badge-warning">Pendiente</span>';
            
            const total = invoice.isExport ? 
                invoice.amount : 
                invoice.amount * (1 + CONFIG.IGV_RATE);
            
            row.innerHTML = `
                <td>${invoice.invoice_number}</td>
                <td>${invoice.clientName}</td>
                <td>${invoice.clientRuc}</td>
                <td>${invoice.currency} ${total.toFixed(2)}</td>
                <td>${statusBadge}</td>
                <td>${invoice.date}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="markAsPaid(${invoice.id})">
                        Marcar Pagada
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${invoice.id})">
                        Eliminar
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function markAsPaid(invoiceId) {
        const invoice = AppState.invoices.find(inv => inv.id === invoiceId);
        if (invoice) {
            invoice.status = 'paid';
            updateInvoicesTable();
            updateDashboardMetrics();
            showToast('‚úÖ Factura marcada como pagada', 'success');
        }
    }

    function deleteInvoice(invoiceId) {
        if (confirm('¬øEst√° seguro de eliminar esta factura?')) {
            AppState.invoices = AppState.invoices.filter(inv => inv.id !== invoiceId);
            updateInvoicesTable();
            updateDashboardMetrics();
            updateSystemCounters();
            showToast('‚úÖ Factura eliminada', 'success');
        }
    }

    // ========================================
    // GESTI√ìN DE EMPLEADOS
    // ========================================
    function saveEmployee(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        const employee = {
            dni: formData.get('dni'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            status: formData.get('status'),
            hireDate: formData.get('hireDate'),
            notes: formData.get('notes')
        };

        // Validar DNI √∫nico
        if (AppState.employees.some(emp => emp.dni === employee.dni)) {
            showToast('‚ùå Ya existe un empleado con ese DNI', 'error');
            return;
        }

        AppState.employees.push(employee);
        
        updateEmployeesTable();
        updateSystemCounters();
        hideModal('newEmployee');
        
        showToast('‚úÖ Empleado registrado correctamente', 'success');
    }

    function updateEmployeesTable() {
        const tbody = document.querySelector('#employeesTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        AppState.employees.forEach(employee => {
            const row = document.createElement('tr');
            
            const statusBadge = employee.status === 'activo' ? 
                '<span class="badge badge-success">Activo</span>' : 
                employee.status === 'inactivo' ?
                '<span class="badge badge-danger">Inactivo</span>' :
                '<span class="badge badge-warning">En Licencia</span>';
            
            row.innerHTML = `
                <td>${employee.dni}</td>
                <td>${employee.firstName}</td>
                <td>${employee.lastName}</td>
                <td>${statusBadge}</td>
                <td>${employee.hireDate}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editEmployee('${employee.dni}')">
                        Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee('${employee.dni}')">
                        Eliminar
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function deleteEmployee(dni) {
        if (confirm('¬øEst√° seguro de eliminar este empleado?')) {
            AppState.employees = AppState.employees.filter(emp => emp.dni !== dni);
            updateEmployeesTable();
            updateSystemCounters();
            showToast('‚úÖ Empleado eliminado', 'success');
        }
    }

    // ========================================
    // GESTI√ìN DE ASISTENCIA
    // ========================================
    function saveTimeEntry(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        const employee = AppState.employees.find(emp => emp.dni === formData.get('dni'));
        if (!employee) {
            showToast('‚ùå Empleado no encontrado', 'error');
            return;
        }

        const timeEntry = {
            id: Date.now(),
            dni: formData.get('dni'),
            name: `${employee.firstName} ${employee.lastName}`,
            date: formData.get('date'),
            entryTime: formData.get('entryTime'),
            exitTime: formData.get('exitTime')
        };

        AppState.timeEntries.push(timeEntry);
        
        updateTimeTrackingTable();
        hideModal('timeEntry');
        
        showToast('‚úÖ Asistencia registrada correctamente', 'success');
    }

    function updateTimeTrackingTable() {
        const tbody = document.querySelector('#timeTrackingTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        AppState.timeEntries.forEach(entry => {
            const row = document.createElement('tr');
            
            const status = entry.exitTime ? 
                '<span class="badge badge-success">Completo</span>' : 
                '<span class="badge badge-warning">En curso</span>';
            
            row.innerHTML = `
                <td>${entry.name}</td>
                <td>${entry.date}</td>
                <td>${entry.entryTime || '-'}</td>
                <td>${entry.exitTime || '-'}</td>
                <td>${status}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editTimeEntry(${entry.id})">
                        Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTimeEntry(${entry.id})">
                        Eliminar
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function deleteTimeEntry(entryId) {
        if (confirm('¬øEst√° seguro de eliminar este registro?')) {
            AppState.timeEntries = AppState.timeEntries.filter(entry => entry.id !== entryId);
            updateTimeTrackingTable();
            showToast('‚úÖ Registro eliminado', 'success');
        }
    }

    // ========================================
    // FUNCIONES DE EXPORTACI√ìN
    // ========================================
    function exportInvoices() {
        showToast('üì• Exportando facturas...', 'info');
        
        const headers = ['N¬∞ Factura', 'Cliente', 'RUC/DNI', 'Moneda', 'Monto Base', 'IGV', 'Total', 'Estado', 'Fecha', 'Descripci√≥n'];
        
        let csvContent = 'EXPORTACI√ìN DE FACTURAS - TECSITEL\n';
        csvContent += 'Fecha de exportaci√≥n: ' + new Date().toLocaleDateString() + '\n\n';
        csvContent += headers.join(',') + '\n';
        
        AppState.invoices.forEach(invoice => {
            const igv = invoice.isExport ? 0 : invoice.amount * CONFIG.IGV_RATE;
            const total = invoice.amount + igv;
            const status = invoice.status === 'paid' ? 'Pagada' : 'Pendiente';
            
            const row = [
                invoice.invoice_number,
                `"${invoice.clientName}"`,
                invoice.clientRuc,
                invoice.currency,
                invoice.amount.toFixed(2),
                igv.toFixed(2),
                total.toFixed(2),
                status,
                invoice.date,
                `"${invoice.description || ''}"`
            ];
            
            csvContent += row.join(',') + '\n';
        });
        
        downloadCSV(csvContent, 'facturas_tecsitel.csv');
        AppState.backupCounter++;
        updateSystemCounters();
        showToast('‚úÖ Facturas exportadas correctamente', 'success');
    }

    function exportEmployees() {
        showToast('üì• Exportando empleados...', 'info');
        
        const headers = ['DNI', 'Nombres', 'Apellidos', 'Estado', 'Fecha Ingreso', 'Notas'];
        
        let csvContent = 'EXPORTACI√ìN DE EMPLEADOS - TECSITEL\n';
        csvContent += 'Fecha de exportaci√≥n: ' + new Date().toLocaleDateString() + '\n\n';
        csvContent += headers.join(',') + '\n';
        
        AppState.employees.forEach(employee => {
            const row = [
                employee.dni,
                `"${employee.firstName}"`,
                `"${employee.lastName}"`,
                employee.status,
                employee.hireDate,
                `"${employee.notes || ''}"`
            ];
            
            csvContent += row.join(',') + '\n';
        });
        
        downloadCSV(csvContent, 'empleados_tecsitel.csv');
        AppState.backupCounter++;
        updateSystemCounters();
        showToast('‚úÖ Empleados exportados correctamente', 'success');
    }

    function downloadFullBackup() {
        showToast('üì• Generando respaldo completo...', 'info');

        let csvContent = 'RESPALDO COMPLETO TECSITEL - ' + new Date().toLocaleDateString() + '\n';
        csvContent += 'Empresa: ' + CONFIG.COMPANY.NAME + '\n';
        csvContent += 'RUC: ' + CONFIG.COMPANY.RUC + '\n';
        csvContent += 'Versi√≥n: ' + CONFIG.VERSION + '\n\n';
        
        // Secci√≥n Facturas
        csvContent += 'SECCI√ìN: FACTURAS\n';
        const invoiceHeaders = ['N¬∞ Factura', 'Cliente', 'RUC/DNI', 'Moneda', 'Monto', 'IGV', 'Total', 'Estado', 'Fecha', 'Exportaci√≥n', 'Descripci√≥n'];
        csvContent += invoiceHeaders.join(',') + '\n';
        
        AppState.invoices.forEach(invoice => {
            const igv = invoice.isExport ? 0 : invoice.amount * CONFIG.IGV_RATE;
            const total = invoice.amount + igv;
            const status = invoice.status === 'paid' ? 'Pagada' : 'Pendiente';
            
            const row = [
                invoice.invoice_number,
                `"${invoice.clientName}"`,
                invoice.clientRuc,
                invoice.currency,
                invoice.amount.toFixed(2),
                igv.toFixed(2),
                total.toFixed(2),
                status,
                invoice.date,
                invoice.isExport ? 'S√≠' : 'No',
                `"${invoice.description || ''}"`
            ];
            
            csvContent += row.join(',') + '\n';
        });

        csvContent += '\nSECCI√ìN: EMPLEADOS\n';
        const employeeHeaders = ['DNI', 'Nombres', 'Apellidos', 'Estado', 'Fecha Ingreso', 'Notas'];
        csvContent += employeeHeaders.join(',') + '\n';
        
        AppState.employees.forEach(employee => {
            const row = [
                employee.dni,
                `"${employee.firstName}"`,
                `"${employee.lastName}"`,
                employee.status,
                employee.hireDate,
                `"${employee.notes || ''}"`
            ];
            
            csvContent += row.join(',') + '\n';
        });

        csvContent += '\nSECCI√ìN: REGISTRO DE ASISTENCIA\n';
        const timeHeaders = ['DNI', 'Empleado', 'Fecha', 'Hora Entrada', 'Hora Salida', 'Horas Trabajadas'];
        csvContent += timeHeaders.join(',') + '\n';
        
        AppState.timeEntries.forEach(entry => {
            let hoursWorked = '';
            if (entry.entryTime && entry.exitTime) {
                const entryDate = new Date(`${entry.date}T${entry.entryTime}`);
                const exitDate = new Date(`${entry.date}T${entry.exitTime}`);
                const diffMs = exitDate - entryDate;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                hoursWorked = `${diffHours}:${diffMinutes.toString().padStart(2, '0')}`;
            }
            
            const row = [
                entry.dni,
                `"${entry.name}"`,
                entry.date,
                entry.entryTime || '',
                entry.exitTime || '',
                hoursWorked
            ];
            
            csvContent += row.join(',') + '\n';
        });

        downloadCSV(csvContent, `respaldo_completo_tecsitel_${new Date().toISOString().split('T')[0]}.csv`);
        AppState.backupCounter++;
        updateSystemCounters();
        showToast('‚úÖ Respaldo completo generado', 'success');
    }

    function downloadJSONBackup() {
        showToast('üì• Generando respaldo JSON...', 'info');
        
        const backup = {
            metadata: {
                version: CONFIG.VERSION,
                company: CONFIG.COMPANY,
                exportDate: new Date().toISOString(),
                totalInvoices: AppState.invoices.length,
                totalEmployees: AppState.employees.length,
                totalTimeEntries: AppState.timeEntries.length
            },
            data: {
                invoices: AppState.invoices,
                employees: AppState.employees,
                timeEntries: AppState.timeEntries,
                counters: {
                    invoiceCounter: AppState.invoiceCounter,
                    backupCounter: AppState.backupCounter + 1
                }
            }
        };
        
        const jsonString = JSON.stringify(backup, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `respaldo_tecsitel_${new Date().toISOString().split('T')[0]}.json`;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        AppState.backupCounter++;
        updateSystemCounters();
        showToast('‚úÖ Respaldo JSON descargado', 'success');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
    }

    function generatePDFReport() {
        showToast('üìÑ Generando reporte PDF...', 'info');
        
        // Simulaci√≥n de generaci√≥n PDF
        setTimeout(() => {
            showToast('‚ö†Ô∏è Funci√≥n PDF requiere librer√≠a externa (jsPDF)', 'warning');
            console.log('Para implementar PDF real, usar jsPDF o similar');
        }, 1000);
    }

    function generateAccountingReport() {
        showToast('üìä Generando reporte contable...', 'info');
        
        const totalIncome = AppState.invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.amount, 0);

        const totalIGV = AppState.invoices
            .filter(inv => inv.status === 'paid' && !inv.isExport)
            .reduce((sum, inv) => sum + (inv.amount * CONFIG.IGV_RATE), 0);

        const totalGross = totalIncome + totalIGV;

        let reportContent = 'REPORTE CONTABLE TECSITEL\n';
        reportContent += '============================\n';
        reportContent += `Fecha: ${new Date().toLocaleDateString()}\n`;
        reportContent += `Per√≠odo: ${new Date().toLocaleDateString()}\n\n`;
        
        reportContent += 'RESUMEN FINANCIERO\n';
        reportContent += '------------------\n';
        reportContent += `Ingresos Netos: S/ ${totalIncome.toFixed(2)}\n`;
        reportContent += `IGV Cobrado: S/ ${totalIGV.toFixed(2)}\n`;
        reportContent += `Total Bruto: S/ ${totalGross.toFixed(2)}\n\n`;
        
        reportContent += 'FACTURAS PAGADAS\n';
        reportContent += '----------------\n';
        AppState.invoices
            .filter(inv => inv.status === 'paid')
            .forEach(inv => {
                const igv = inv.isExport ? 0 : inv.amount * CONFIG.IGV_RATE;
                reportContent += `${inv.invoice_number} - ${inv.clientName} - S/ ${(inv.amount + igv).toFixed(2)}\n`;
            });

        downloadCSV(reportContent, `reporte_contable_${new Date().toISOString().split('T')[0]}.txt`);
        showToast('‚úÖ Reporte contable generado', 'success');
    }

    // ========================================
    // FUNCIONES DE NAVEGACI√ìN Y UI
    // ========================================
    function showTab(tabName) {
        if (!tabName) return;
        
        // Ocultar todos los tabs
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        // Mostrar tab seleccionado
        const tabElement = document.getElementById(tabName);
        if (tabElement) tabElement.classList.add('active');
        
        // Actualizar navegaci√≥n activa
        document.querySelectorAll('.nav-item').forEach(i => {
            i.classList.toggle('active', i.dataset.tab === tabName);
        });
        
        // Actualizar t√≠tulo de p√°gina
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            const titles = {
                'dashboard': 'Dashboard',
                'invoices': 'Gesti√≥n de Facturas', 
                'accounting': 'Contabilidad',
                'personnel': 'Gesti√≥n de Personal',
                'compliance': 'Cumplimiento Normativo',
                'sharepoint': 'Respaldos y Exportaci√≥n'
            };
            pageTitle.textContent = titles[tabName] || tabName;
        }
        
        // Cerrar sidebar en m√≥viles
        if (window.innerWidth <= 1024) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.remove('active');
        }
    }

    function setupEventListeners() {
        try {
            // Navegaci√≥n
            document.body.addEventListener('click', e => {
                const navItem = e.target.closest('.nav-item');
                if (navItem && navItem.dataset.tab) {
                    showTab(navItem.dataset.tab);
                }
            });

            // Cerrar modales al hacer clic fuera
            document.addEventListener('click', e => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });

            // Prevenir cierre de modal al hacer clic dentro del contenido
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', e => {
                    e.stopPropagation();
                });
            });

            // Manejo de formularios
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error configurando event listeners:', error);
        }
    }

    function updateAllTables() {
        updateInvoicesTable();
        updateEmployeesTable();
        updateTimeTrackingTable();
        updateDashboardMetrics();
        updateSystemCounters();
    }

    // ========================================
    // SISTEMA DE NOTIFICACIONES
    // ========================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;">&times;</button>
            </div>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove despu√©s de 4 segundos
        setTimeout(() => {
            if (toast.parentNode) {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }
        }, 4000);
    }

    // ========================================
    // FUNCIONES DE VALIDACI√ìN
    // ========================================
    function validateRUC(ruc) {
        // Validaci√≥n b√°sica de RUC peruano
        if (!/^\d{11}$/.test(ruc)) return false;
        if (!['10', '15', '17', '20'].includes(ruc.substring(0, 2))) return false;
        return true;
    }

    function validateDNI(dni) {
        // Validaci√≥n b√°sica de DNI peruano
        return /^\d{8}$/.test(dni);
    }

    function formatCurrency(amount, currency = 'PEN') {
        const symbols = { PEN: 'S/', USD: ', EUR: '‚Ç¨' };
        return `${symbols[currency] || currency} ${amount.toFixed(2)}`;
    }

    // ========================================
    // FUNCIONES DE EDICI√ìN
    // ========================================
    function editEmployee(dni) {
        const employee = AppState.employees.find(emp => emp.dni === dni);
        if (!employee) return;
        
        showModal('newEmployee');
        
        // Llenar formulario con datos existentes
        const form = document.getElementById('employeeForm');
        form.dni.value = employee.dni;
        form.dni.readOnly = true; // No permitir cambiar DNI
        form.firstName.value = employee.firstName;
        form.lastName.value = employee.lastName;
        form.status.value = employee.status;
        form.hireDate.value = employee.hireDate;
        form.notes.value = employee.notes || '';
        
        // Cambiar el comportamiento del formulario para edici√≥n
        form.onsubmit = function(event) {
            event.preventDefault();
            
            const formData = new FormData(form);
            
            // Actualizar empleado existente
            Object.assign(employee, {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                status: formData.get('status'),
                hireDate: formData.get('hireDate'),
                notes: formData.get('notes')
            });
            
            updateEmployeesTable();
            updateSystemCounters();
            hideModal('newEmployee');
            
            // Restaurar comportamiento normal del formulario
            form.onsubmit = saveEmployee;
            form.dni.readOnly = false;
            
            showToast('‚úÖ Empleado actualizado correctamente', 'success');
        };
    }

    function editTimeEntry(entryId) {
        const entry = AppState.timeEntries.find(e => e.id === entryId);
        if (!entry) return;
        
        showModal('timeEntry');
        populateEmployeeSelect();
        
        // Llenar formulario con datos existentes
        const form = document.getElementById('timeEntryForm');
        form.dni.value = entry.dni;
        form.date.value = entry.date;
        form.entryTime.value = entry.entryTime || '';
        form.exitTime.value = entry.exitTime || '';
        
        // Cambiar el comportamiento del formulario para edici√≥n
        form.onsubmit = function(event) {
            event.preventDefault();
            
            const formData = new FormData(form);
            const employee = AppState.employees.find(emp => emp.dni === formData.get('dni'));
            
            // Actualizar entrada existente
            Object.assign(entry, {
                dni: formData.get('dni'),
                name: `${employee.firstName} ${employee.lastName}`,
                date: formData.get('date'),
                entryTime: formData.get('entryTime'),
                exitTime: formData.get('exitTime')
            });
            
            updateTimeTrackingTable();
            hideModal('timeEntry');
            
            // Restaurar comportamiento normal del formulario
            form.onsubmit = saveTimeEntry;
            
            showToast('‚úÖ Registro de asistencia actualizado', 'success');
        };
    }

    // ========================================
    // INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üì± TECSITEL v3.0 - Inicializando...');
        
        // Inicializar fecha actual en formularios
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => {
            if (!input.value) input.value = today;
        });
        
        console.log('‚úÖ Sistema listo para autenticaci√≥n');
    });

    // Prevenir que la p√°gina se quede cargando indefinidamente
    window.addEventListener('beforeunload', function() {
        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
        }
    });

    // Manejo de errores globales
    window.addEventListener('error', function(e) {
        console.error('‚ùå Error global:', e.error);
        showToast('‚ö†Ô∏è Se produjo un error inesperado', 'error');
    });

    // Inicializaci√≥n de la aplicaci√≥n cuando se carga la p√°gina
    window.addEventListener('load', function() {
        console.log('üéØ P√°gina cargada completamente');
        
        // Auto-rellenar credenciales para demo
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('password');
        
        if (usernameField && !usernameField.value) {
            usernameField.placeholder = 'admin (demo)';
        }
        if (passwordField && !passwordField.value) {
            passwordField.placeholder = 'admin123 (demo)';
        }
    });

    </script>
</body>
</html>
